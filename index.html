<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meal Planner — Macros</title>
  <meta name="theme-color" content="#0b1224" />
  <style>
    :root { --bg:#07101b; --card:#0b1224; --muted:#9ca3af; --text:#e6eef6; --accent:#22c55e; --border:#172033; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:linear-gradient(180deg,#04101a,#07101b); color:var(--text); }
    header { padding:14px 16px; border-bottom:1px solid var(--border); background:rgba(11,18,36,.55); position:sticky; top:0; backdrop-filter: blur(8px); z-index:5; }
    main { padding:16px; max-width:1150px; margin:0 auto; display:grid; gap:14px; }
    .grid { display:grid; gap:14px; grid-template-columns: 1.25fr .75fr; }
    @media (max-width:920px){ .grid{ grid-template-columns:1fr } }

    .card { background:rgba(13,21,34,.9); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 8px 24px rgba(0,0,0,.4); }
    h1 { margin:0; font-size:18px; }
    h2 { margin:0 0 10px; font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; }

    .row { display:flex; gap:10px; align-items:center; }
    input, textarea, button { font:inherit; color:var(--text); background:transparent; border:1px solid var(--border); border-radius:10px; padding:8px 10px; }
    input::placeholder, textarea::placeholder { color:#6b7280; }
    input[type=number] { max-width:140px; }
    button { cursor:pointer; }
    button.primary { background: linear-gradient(135deg,#16a34a,#22c55e); border-color: rgba(34,197,94,.25); color:#03110a; font-weight:700; }
    .muted { color:var(--muted); font-size:12px; }
    .micro { font-size:12px; color:var(--muted); }
    .smallBtn { padding:6px 8px; border-radius:8px; }
    .danger { border-color: rgba(239,68,68,.25); color:#fecaca; }

    .week { display:grid; gap:12px; }

    .dayCard {
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.02), transparent);
      display:grid;
      gap:10px;
    }
    .dayHeader { display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap; }
    .dayTitle strong { font-size:14px; }
    .dayTitle .micro { margin-top:2px; }

    .totalsBox { text-align:right; min-width:220px; }
    .totalsBox .kcal { font-size:15px; font-weight:800; }
    .status { margin-top:6px; font-size:12px; }
    .status.good { color:#86efac; }
    .status.ok { color:#fde68a; }
    .status.bad { color:#fca5a5; }

    .progressWrap { margin-top:8px; display:grid; gap:8px; }
    .progRow { display:grid; grid-template-columns: 64px 1fr 90px; gap:8px; align-items:center; }
    .progLabel { font-size:12px; color:var(--muted); }
    .bar { height:10px; border-radius:999px; border:1px solid var(--border); overflow:hidden; background:rgba(255,255,255,.02); }
    .bar > div { height:100%; width:0%; background:linear-gradient(135deg,#16a34a,#22c55e); }
    .progVal { font-size:12px; color:var(--muted); text-align:right; }

    .meals { display:grid; gap:8px; }
    .mealRow {
      display:grid;
      grid-template-columns: 110px 1fr auto auto;
      gap:8px;
      align-items:center;
      padding:10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:rgba(11,18,36,.6);
    }
    .mealRow.dragOver { outline:2px dashed rgba(34,197,94,.55); outline-offset:2px; }
    .mealRow[draggable="true"] { cursor: grab; }
    .mealRow:active { cursor: grabbing; }
    @media (max-width:640px){
      .mealRow { grid-template-columns: 98px 1fr auto; grid-auto-rows:auto; }
      .mealRow .mealServ { grid-column: 2 / 3; justify-self:start; }
      .mealRow .mealBtn { grid-column: 3 / 4; justify-self:end; }
    }

    .pill {
      font-size:13px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.02);
      max-width:56vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .pill.empty { color:#6b7280; }

    .list { display:flex; flex-direction:column; gap:8px; max-height:320px; overflow:auto; padding-right:4px; }
    .dish {
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:8px; border-radius:10px; border:1px solid var(--border);
    }
    .dish[draggable="true"] { cursor: grab; }
    .dish small { color:var(--muted); font-size:12px; margin-left:6px; }

    dialog { border:none; border-radius:12px; padding:0; width:min(700px, 94vw); background:var(--card); color:var(--text); }
    dialog::backdrop { background:rgba(0,0,0,.6); }
    .dlg { padding:14px; }
    .footer { display:flex; justify-content:space-between; gap:10px; margin-top:10px; flex-wrap:wrap; }

    .targetsGrid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:520px){ .targetsGrid { grid-template-columns:1fr; } }
    .targetsGrid label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .targetsGrid .field { display:flex; flex-direction:column; }

    .hintBox {
      margin-top:10px;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      color:var(--muted);
      font-size:12px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Meal Planner — Macros</h1>
    <div class="micro">Per-serving dish macros + servings per meal. Drag dishes onto meals, or drag meals to swap.</div>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <h2>Week plan</h2>

        <div class="row" style="justify-content:space-between; margin-bottom:10px; flex-wrap:wrap;">
          <div class="row">
            <button class="smallBtn" id="prevWeek">←</button>
            <button class="smallBtn" id="nextWeek">→</button>
            <div class="muted" id="weekRange" style="margin-left:10px;"></div>
          </div>

          <div class="row" style="flex-wrap:wrap;">
            <button id="fillEmpty" class="smallBtn">Fill empty meals (smart)</button>
            <button id="shuffleWeek" class="smallBtn">Shuffle week</button>
            <button class="primary" id="copyPlan">Copy plan</button>
            <button id="exportCSV" class="smallBtn">Export CSV</button>
          </div>
        </div>

        <div class="week" id="week"></div>

        <div class="hintBox">
          Drag & drop:
          <br>• Drag a <b>dish</b> from the right onto a meal slot to set it.
          <br>• Drag a <b>meal slot</b> onto another meal slot to swap them.
        </div>
      </section>

      <aside class="card">
        <h2>Daily targets</h2>
        <div class="targetsGrid" style="margin-bottom:10px;">
          <div class="field">
            <label for="tCal">Calories (kcal)</label>
            <input id="tCal" type="number" min="0" step="10" placeholder="e.g. 2200" />
          </div>
          <div class="field">
            <label for="tProtein">Protein (g)</label>
            <input id="tProtein" type="number" min="0" step="1" placeholder="e.g. 160" />
          </div>
          <div class="field">
            <label for="tCarbs">Carbs (g)</label>
            <input id="tCarbs" type="number" min="0" step="1" placeholder="e.g. 220" />
          </div>
          <div class="field">
            <label for="tFat">Fat (g)</label>
            <input id="tFat" type="number" min="0" step="1" placeholder="e.g. 70" />
          </div>
        </div>
        <div class="row" style="justify-content:space-between; margin-bottom:14px;">
          <div class="muted">Used by smart fill + daily progress bars.</div>
          <button id="saveTargets" class="smallBtn">Save targets</button>
        </div>

        <h2>Dishes & Macros</h2>
        <div style="margin-bottom:10px;">
          <div style="display:grid; gap:8px;">
            <input id="dishName" placeholder="Dish name" />
            <div class="row" style="flex-wrap:wrap;">
              <input id="dishCal" placeholder="Calories (kcal)" type="number" min="0" />
              <input id="dishProtein" placeholder="Protein (g)" type="number" min="0" />
              <input id="dishCarbs" placeholder="Carbs (g)" type="number" min="0" />
              <input id="dishFat" placeholder="Fat (g)" type="number" min="0" />
              <button class="primary" id="saveDish">Save</button>
            </div>
            <div class="muted">Per-serving values. Import format now: <b>name, calories, protein, carbs, fat</b>.</div>
          </div>
        </div>

        <details style="margin-bottom:10px;">
          <summary class="muted" style="cursor:pointer;">Import CSV (one per line)</summary>
          <div style="margin-top:10px;">
            <textarea id="bulk" placeholder="Example: Pasta bake,650,25,80,18" style="width:100%; min-height:86px;"></textarea>
            <div class="row" style="justify-content:space-between; margin-top:8px;">
              <span class="muted">Format: name, calories, protein, carbs, fat</span>
              <button id="importBulk" class="smallBtn">Import</button>
            </div>
          </div>
        </details>

        <div class="row" style="margin-bottom:10px;">
          <input id="search" placeholder="Search dishes…" style="flex:1;" />
          <button id="clearSearch" class="smallBtn">✕</button>
        </div>

        <div class="list" id="dishList"></div>

        <div style="display:flex; justify-content:space-between; margin-top:10px;">
          <span class="muted" id="count"></span>
          <button id="reset" class="danger smallBtn">Reset</button>
        </div>
      </aside>
    </div>
  </main>

  <!-- Picker dialog -->
  <dialog id="picker">
    <div class="dlg">
      <h3 id="pickTitle">Pick a dish</h3>

      <div class="row" style="margin:8px 0;">
        <input id="pickSearch" placeholder="Search…" style="flex:1;" />
        <button class="smallBtn" id="pickClear">✕</button>
      </div>

      <div class="list" id="pickList"></div>

      <div class="footer" style="align-items:center;">
        <div class="row" style="gap:8px;">
          <label class="muted">Servings:</label>
          <input id="servings" style="width:90px;" type="number" min="0.25" step="0.25" value="1" />
        </div>
        <div class="row" style="gap:8px;">
          <button id="clearMeal" class="danger smallBtn">Clear meal</button>
          <button id="closePicker" class="smallBtn">Close</button>
        </div>
      </div>
    </div>
  </dialog>

<script>
(() => {
  const DAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  const MEALS = ["Breakfast","Lunch","Dinner"];
  const KEY = "mealPlanner.macro.v3";

  function defaultState() {
    return {
      targets: { cal: 2200, protein: 160, carbs: 220, fat: 70 },
      dishes: [
        { id: crypto.randomUUID(), name: "Pasta bake", cal: 650, protein: 25, carbs: 80, fat: 18 },
        { id: crypto.randomUUID(), name: "Chicken & rice", cal: 520, protein: 40, carbs: 55, fat: 10 },
        { id: crypto.randomUUID(), name: "Greek yoghurt + berries", cal: 280, protein: 20, carbs: 30, fat: 6 }
      ],
      planByWeekStart: {}
    };
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return defaultState();
      const parsed = JSON.parse(raw);
      if (!parsed.dishes || !parsed.planByWeekStart) return defaultState();
      if (!parsed.targets) parsed.targets = defaultState().targets;
      // migrate fat if missing
      parsed.dishes = parsed.dishes.map(d => ({ fat: 0, ...d }));
      parsed.targets = { fat: 0, ...parsed.targets };
      return parsed;
    } catch {
      return defaultState();
    }
  }
  function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  let state = loadState();

  // ---- date helpers (Monday-start week) ----
  function startOfWeek(date) {
    const d = new Date(date);
    d.setHours(0,0,0,0);
    const day = (d.getDay() + 6) % 7;
    d.setDate(d.getDate() - day);
    return d;
  }
  function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
  function toISO(d){ const x = new Date(d); x.setHours(0,0,0,0); return x.toISOString().slice(0,10); }
  function fmtRange(ws){
    const a = new Date(ws), b = addDays(a,6);
    const opts = { day:"2-digit", month:"short" };
    return `${a.toLocaleDateString(undefined,opts)} – ${b.toLocaleDateString(undefined,opts)} ${a.getFullYear()}`;
  }

  let weekStart = startOfWeek(new Date());

  function emptyMeal(){ return { dishId: null, servings: 1 }; }
  function emptyDay(){
    const obj = {};
    MEALS.forEach(m => obj[m] = emptyMeal());
    return obj;
  }

  function ensureWeekPlan(ws=weekStart){
    const key = toISO(ws);
    if (!state.planByWeekStart[key]) {
      state.planByWeekStart[key] = Object.fromEntries(DAYS.map(d => [d, emptyDay()]));
      saveState();
    } else {
      // migrate older structures safely
      DAYS.forEach(day => {
        if (!state.planByWeekStart[key][day]) state.planByWeekStart[key][day] = emptyDay();
        MEALS.forEach(meal => {
          if (!state.planByWeekStart[key][day][meal]) state.planByWeekStart[key][day][meal] = emptyMeal();
          if (state.planByWeekStart[key][day][meal].servings == null) state.planByWeekStart[key][day][meal].servings = 1;
        });
      });
    }
    return state.planByWeekStart[key];
  }

  // ---- DOM refs ----
  const elWeek = document.getElementById("week");
  const elWeekRange = document.getElementById("weekRange");
  const elDishList = document.getElementById("dishList");
  const elCount = document.getElementById("count");
  const elSearch = document.getElementById("search");

  const elDishName = document.getElementById("dishName");
  const elDishCal = document.getElementById("dishCal");
  const elDishProtein = document.getElementById("dishProtein");
  const elDishCarbs = document.getElementById("dishCarbs");
  const elDishFat = document.getElementById("dishFat");
  const elBulk = document.getElementById("bulk");

  const tCal = document.getElementById("tCal");
  const tProtein = document.getElementById("tProtein");
  const tCarbs = document.getElementById("tCarbs");
  const tFat = document.getElementById("tFat");

  const dlg = document.getElementById("picker");
  const pickTitle = document.getElementById("pickTitle");
  const pickSearch = document.getElementById("pickSearch");
  const pickList = document.getElementById("pickList");
  const servingsInput = document.getElementById("servings");

  let activeDay = null;
  let activeMeal = null;

  // ---- utilities ----
  function toast(msg){
    let el = document.getElementById("__toast");
    if (!el) {
      el = document.createElement("div");
      el.id="__toast";
      el.style.cssText = "position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(10,18,30,.95);padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.03);box-shadow:0 10px 30px rgba(0,0,0,.4);font-size:13px;color:var(--text);z-index:9999;opacity:0;transition:opacity .15s;";
      document.body.appendChild(el);
    }
    el.textContent = msg;
    el.style.opacity = "1";
    setTimeout(()=> el.style.opacity="0", 1500);
  }

  function normalizeName(s){ return (s||"").trim().replace(/\s+/g," "); }
  function getDish(id){ return state.dishes.find(d => d.id === id) || null; }
  function filteredDishes(q){
    const s=(q||"").trim().toLowerCase();
    const arr=[...state.dishes].sort((a,b)=>a.name.localeCompare(b.name));
    if (!s) return arr;
    return arr.filter(d => d.name.toLowerCase().includes(s));
  }

  function clearDishForm(){
    elDishName.value = "";
    elDishCal.value = "";
    elDishProtein.value = "";
    elDishCarbs.value = "";
    elDishFat.value = "";
    elDishName.dataset.editing = "";
  }

  function dayTotals(dayObj){
    let cal=0, protein=0, carbs=0, fat=0;
    MEALS.forEach(meal => {
      const entry = dayObj[meal];
      if (!entry?.dishId) return;
      const d = getDish(entry.dishId);
      if (!d) return;
      const s = Number(entry.servings) || 0;
      cal += (Number(d.cal)||0) * s;
      protein += (Number(d.protein)||0) * s;
      carbs += (Number(d.carbs)||0) * s;
      fat += (Number(d.fat)||0) * s;
    });
    return { cal, protein, carbs, fat };
  }

  function hasTargets(){
    const tar = state.targets || {};
    return (tar.cal||0) > 0 || (tar.protein||0) > 0 || (tar.carbs||0) > 0 || (tar.fat||0) > 0;
  }

  // status heuristic: kcal ±10% ok; macros ±15% ok
  function dayStatus(tot){
    const tar = state.targets || { cal:0, protein:0, carbs:0, fat:0 };
    if (!hasTargets()) return { label:"No targets set", cls:"ok", icon:"⚠️" };

    function band(actual, target, pctOk){
      if (!target) return "skip";
      const lo = target * (1 - pctOk);
      const hi = target * (1 + pctOk);
      if (actual >= lo && actual <= hi) return "good";
      const lo2 = target * (1 - (pctOk*2));
      const hi2 = target * (1 + (pctOk*2));
      if (actual >= lo2 && actual <= hi2) return "ok";
      return "bad";
    }

    const a = band(tot.cal, tar.cal, 0.10);
    const b = band(tot.protein, tar.protein, 0.15);
    const c = band(tot.carbs, tar.carbs, 0.15);
    const d = band(tot.fat, tar.fat, 0.15);

    const ranks = { good:2, ok:1, bad:0, skip:2 };
    const worst = [a,b,c,d].reduce((w,x)=> ranks[x] < ranks[w] ? x : w, "good");

    if (worst === "good") return { icon:"✅", cls:"good", label:"On target" };
    if (worst === "ok") return { icon:"⚠️", cls:"ok", label:"Close to target" };
    return { icon:"❌", cls:"bad", label:"Off target" };
  }

  // progress percentage capped
  function pct(actual, target){
    if (!target || target <= 0) return 0;
    const p = (actual / target) * 100;
    return Math.max(0, Math.min(140, p)); // allow >100% up to 140% for visibility
  }

  // distance metric for greedy solver (normalized squared error)
  function scoreAgainstTargets(tot){
    const tar = state.targets || { cal:0, protein:0, carbs:0, fat:0 };
    if (!hasTargets()) return 0;

    function term(actual, target){
      if (!target || target <= 0) return 0;
      const diff = (actual - target) / target; // normalized
      return diff * diff;
    }

    // weight protein slightly higher (common macro focus)
    const wCal = 1.0, wProtein = 1.4, wCarbs = 1.1, wFat = 1.1;
    return (
      wCal * term(tot.cal, tar.cal) +
      wProtein * term(tot.protein, tar.protein) +
      wCarbs * term(tot.carbs, tar.carbs) +
      wFat * term(tot.fat, tar.fat)
    );
  }

  // ---- rendering ----
  function render(){
    elWeekRange.textContent = fmtRange(weekStart);
    renderTargetsUI();
    renderWeek();
    renderDishList();
  }

  function renderTargetsUI(){
    const tar = state.targets || {};
    tCal.value = tar.cal ?? "";
    tProtein.value = tar.protein ?? "";
    tCarbs.value = tar.carbs ?? "";
    tFat.value = tar.fat ?? "";
  }

  function macroProgressHTML(tot){
    const tar = state.targets || {};
    const rows = [
      { k:"kcal", label:"kcal", a:tot.cal, t:tar.cal },
      { k:"P", label:"Prot", a:tot.protein, t:tar.protein },
      { k:"C", label:"Carb", a:tot.carbs, t:tar.carbs },
      { k:"F", label:"Fat", a:tot.fat, t:tar.fat },
    ];
    return `
      <div class="progressWrap">
        ${rows.map(r => {
          const p = pct(r.a, r.t);
          const shown = r.t ? `${Math.round(r.a)}/${Math.round(r.t)}` : `${Math.round(r.a)}/–`;
          return `
            <div class="progRow">
              <div class="progLabel">${r.label}</div>
              <div class="bar"><div style="width:${p}%"></div></div>
              <div class="progVal">${shown}</div>
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  function renderWeek(){
    const plan = ensureWeekPlan();
    elWeek.innerHTML = "";

    DAYS.forEach((day, idx) => {
      const date = toISO(addDays(weekStart, idx));
      const dayObj = plan[day];
      const tot = dayTotals(dayObj);
      const st = dayStatus(tot);

      const wrap = document.createElement("div");
      wrap.className = "dayCard";
      wrap.innerHTML = `
        <div class="dayHeader">
          <div class="dayTitle">
            <strong>${day}</strong>
            <div class="micro">${date}</div>
          </div>
          <div class="totalsBox">
            <div class="kcal">${Math.round(tot.cal)} kcal</div>
            <div class="micro">${Math.round(tot.protein)}g P • ${Math.round(tot.carbs)}g C • ${Math.round(tot.fat)}g F</div>
            <div class="status ${st.cls}">${st.icon} ${st.label}</div>
            ${macroProgressHTML(tot)}
          </div>
        </div>

        <div class="meals">
          ${MEALS.map(meal => {
            const e = dayObj[meal];
            const d = e?.dishId ? getDish(e.dishId) : null;
            const servings = e?.servings ?? 1;

            const mealCal = d ? (Number(d.cal)||0) * (Number(servings)||0) : 0;
            const mealP   = d ? (Number(d.protein)||0) * (Number(servings)||0) : 0;
            const mealC   = d ? (Number(d.carbs)||0) * (Number(servings)||0) : 0;
            const mealF   = d ? (Number(d.fat)||0) * (Number(servings)||0) : 0;

            return `
              <div class="mealRow"
                   draggable="true"
                   data-day="${day}"
                   data-meal="${meal}">
                <div class="muted"><strong>${meal}</strong></div>

                <div class="pill ${d ? "" : "empty"}"
                     title="${d ? d.name : "Drop a dish here or tap Edit"}">
                  ${d ? d.name : "Drop a dish here or tap Edit"}
                </div>

                <div class="micro mealServ">
                  Serv: <strong>${servings}</strong> •
                  ${Math.round(mealCal)} kcal •
                  ${Math.round(mealP)}P ${Math.round(mealC)}C ${Math.round(mealF)}F
                </div>

                <div class="mealBtn">
                  <button class="smallBtn" data-edit="1">Edit</button>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;

      // wire up buttons + drag/drop for meal slots
      wrap.querySelectorAll(".mealRow").forEach(row => {
        // Edit button
        row.querySelector("button[data-edit]").addEventListener("click", () => {
          openPicker(row.dataset.day, row.dataset.meal);
        });

        // Drag meal slot
        row.addEventListener("dragstart", (ev) => {
          const payload = { type:"mealSlot", day: row.dataset.day, meal: row.dataset.meal };
          ev.dataTransfer.setData("application/json", JSON.stringify(payload));
          ev.dataTransfer.effectAllowed = "move";
        });

        // Drop handling (both from dish list and from other meal slots)
        row.addEventListener("dragover", (ev) => {
          ev.preventDefault();
          row.classList.add("dragOver");
          ev.dataTransfer.dropEffect = "move";
        });
        row.addEventListener("dragleave", () => row.classList.remove("dragOver"));
        row.addEventListener("drop", (ev) => {
          ev.preventDefault();
          row.classList.remove("dragOver");
          const json = ev.dataTransfer.getData("application/json");
          if (!json) return;

          let payload;
          try { payload = JSON.parse(json); } catch { return; }

          const targetDay = row.dataset.day;
          const targetMeal = row.dataset.meal;
          const plan = ensureWeekPlan();

          if (payload.type === "dish") {
            // set dish into this meal slot
            plan[targetDay][targetMeal] = { dishId: payload.dishId, servings: 1 };
            saveState();
            renderWeek();
            toast("Dish assigned");
            return;
          }

          if (payload.type === "mealSlot") {
            const fromDay = payload.day;
            const fromMeal = payload.meal;
            // swap
            const a = plan[fromDay][fromMeal];
            const b = plan[targetDay][targetMeal];
            plan[fromDay][fromMeal] = b;
            plan[targetDay][targetMeal] = a;
            saveState();
            renderWeek();
            toast("Meals swapped");
            return;
          }
        });
      });

      elWeek.appendChild(wrap);
    });
  }

  function renderDishList(){
    const list = filteredDishes(elSearch.value);
    elDishList.innerHTML = "";
    list.forEach(d => {
      const el = document.createElement("div");
      el.className = "dish";
      el.setAttribute("draggable","true");
      el.dataset.dishId = d.id;
      el.innerHTML = `
        <div>
          <div><strong>${d.name}</strong> <small class="micro">(${d.cal} kcal, ${d.protein}P, ${d.carbs}C, ${d.fat}F)</small></div>
          <div class="micro">Drag onto a meal slot</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="smallBtn" data-edit="${d.id}">Edit</button>
          <button class="smallBtn" data-delete="${d.id}">Delete</button>
        </div>
      `;

      // drag dish
      el.addEventListener("dragstart", (ev) => {
        const payload = { type:"dish", dishId: d.id };
        ev.dataTransfer.setData("application/json", JSON.stringify(payload));
        ev.dataTransfer.effectAllowed = "copy";
      });

      el.querySelector("[data-delete]").addEventListener("click", () => deleteDish(d.id));
      el.querySelector("[data-edit]").addEventListener("click", () => editDish(d.id));
      elDishList.appendChild(el);
    });

    elCount.textContent = `${state.dishes.length} dish${state.dishes.length===1? "" : "es"}`;
  }

  // ---- dish CRUD ----
  function saveDishFromForm(){
    const name = normalizeName(elDishName.value);
    if (!name) return toast("Name required");

    const cal = Number(elDishCal.value) || 0;
    const protein = Number(elDishProtein.value) || 0;
    const carbs = Number(elDishCarbs.value) || 0;
    const fat = Number(elDishFat.value) || 0;

    const editing = elDishName.dataset.editing;
    if (editing) {
      const idx = state.dishes.findIndex(d => d.id === editing);
      if (idx !== -1) {
        state.dishes[idx] = { ...state.dishes[idx], name, cal, protein, carbs, fat };
        saveState();
        toast("Updated");
        clearDishForm();
        render();
        return;
      }
    }

    if (state.dishes.some(d => d.name.toLowerCase() === name.toLowerCase())) {
      return toast("Already exists");
    }

    state.dishes.push({ id: crypto.randomUUID(), name, cal, protein, carbs, fat });
    saveState();
    toast("Saved");
    clearDishForm();
    render();
  }

  function editDish(id){
    const d = getDish(id);
    if (!d) return;
    elDishName.value = d.name;
    elDishCal.value = d.cal;
    elDishProtein.value = d.protein;
    elDishCarbs.value = d.carbs;
    elDishFat.value = d.fat ?? 0;
    elDishName.dataset.editing = d.id;
    elDishName.focus();
  }

  function deleteDish(id){
    if (!confirm("Delete dish? It will be removed from any plans too.")) return;
    state.dishes = state.dishes.filter(x => x.id !== id);

    for (const wk of Object.keys(state.planByWeekStart)) {
      DAYS.forEach(day => {
        MEALS.forEach(meal => {
          const e = state.planByWeekStart[wk]?.[day]?.[meal];
          if (e?.dishId === id) state.planByWeekStart[wk][day][meal] = emptyMeal();
        });
      });
    }

    saveState();
    toast("Deleted");
    render();
  }

  // ---- targets ----
  function saveTargets(){
    state.targets = {
      cal: Number(tCal.value) || 0,
      protein: Number(tProtein.value) || 0,
      carbs: Number(tCarbs.value) || 0,
      fat: Number(tFat.value) || 0
    };
    saveState();
    toast("Targets saved");
    renderWeek();
  }

  // ---- picker ----
  function openPicker(day, meal){
    activeDay = day;
    activeMeal = meal;
    pickTitle.textContent = `Pick for ${day} — ${meal}`;
    pickSearch.value = "";
    const plan = ensureWeekPlan();
    servingsInput.value = plan[day][meal]?.servings ?? 1;
    renderPicker();
    dlg.showModal();
    pickSearch.focus();
  }

  function renderPicker(){
    const list = filteredDishes(pickSearch.value);
    pickList.innerHTML = "";
    if (list.length === 0) {
      const el = document.createElement("div");
      el.className = "muted";
      el.textContent = "No dishes found.";
      pickList.appendChild(el);
      return;
    }

    list.forEach(d => {
      const row = document.createElement("div");
      row.className = "dish";
      row.innerHTML = `
        <div><strong>${d.name}</strong> <small class="micro">(${d.cal} kcal, ${d.protein}P, ${d.carbs}C, ${d.fat}F)</small></div>
        <div><button class="smallBtn">Choose</button></div>
      `;
      row.querySelector("button").addEventListener("click", () => {
        const servings = Number(servingsInput.value) || 1;
        const plan = ensureWeekPlan();
        plan[activeDay][activeMeal] = { dishId: d.id, servings };
        saveState();
        dlg.close();
        toast("Saved");
        renderWeek();
      });
      pickList.appendChild(row);
    });
  }

  function clearActiveMeal(){
    if (!activeDay || !activeMeal) return;
    const plan = ensureWeekPlan();
    plan[activeDay][activeMeal] = emptyMeal();
    saveState();
    dlg.close();
    toast("Cleared");
    renderWeek();
  }

  // ---- random helper ----
  function shuffleArray(a){
    const arr=[...a];
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  // ---- SMART fill to targets (greedy) ----
  // For each empty meal slot, choose the dish that best improves scoreAgainstTargets for that day.
  // If no targets are set, it falls back to random fill.
  function smartPickDishForDay(dayObj, excludeIdsSet){
    const dishes = state.dishes;
    if (dishes.length === 0) return null;

    // If no targets, just pick a random dish not excluded
    if (!hasTargets()) {
      const pool = dishes.map(d=>d.id).filter(id => !excludeIdsSet.has(id));
      const pickFrom = pool.length ? pool : dishes.map(d=>d.id);
      return pickFrom[Math.floor(Math.random()*pickFrom.length)];
    }

    const currentTot = dayTotals(dayObj);
    const currentScore = scoreAgainstTargets(currentTot);

    let bestId = null;
    let bestScore = Infinity;

    for (const d of dishes) {
      if (excludeIdsSet.has(d.id)) continue;

      // consider adding this dish once (servings fixed 1 for fill)
      const candidateTot = {
        cal: currentTot.cal + (Number(d.cal)||0),
        protein: currentTot.protein + (Number(d.protein)||0),
        carbs: currentTot.carbs + (Number(d.carbs)||0),
        fat: currentTot.fat + (Number(d.fat)||0),
      };
      const s = scoreAgainstTargets(candidateTot);

      // Prefer anything that improves, otherwise still pick the "least bad"
      if (s < bestScore) {
        bestScore = s;
        bestId = d.id;
      }
    }

    // if everything excluded, allow repeats
    if (!bestId) {
      // try again without exclusions
      const d = dishes[Math.floor(Math.random()*dishes.length)];
      return d?.id ?? null;
    }

    // small nudge: if best doesn't improve and we had a score, still accept as least-bad
    if (bestId && bestScore === Infinity) return null;
    // (currentScore is unused, but kept to show intent; you can later force "must improve" if you want)

    return bestId;
  }

  function fillWeek({ onlyEmpty=false, smart=true } = {}){
    const plan = ensureWeekPlan();
    if (state.dishes.length === 0) return toast("Add dishes first");

    // Track used dishes across the entire week to reduce repeats (soft constraint)
    const usedWeek = new Set();
    DAYS.forEach(day => MEALS.forEach(meal => {
      const id = plan[day][meal]?.dishId;
      if (id) usedWeek.add(id);
    }));

    for (const day of DAYS) {
      const dayObj = plan[day];

      for (const meal of MEALS) {
        const isEmpty = !dayObj[meal]?.dishId;
        if (onlyEmpty && !isEmpty) continue;

        // choose dish
        let pickId;
        if (smart) {
          // exclude already-used week dishes if possible
          pickId = smartPickDishForDay(dayObj, usedWeek);
        } else {
          const ids = shuffleArray(state.dishes.map(d=>d.id));
          pickId = ids.find(id => !usedWeek.has(id)) || ids[0];
        }

        if (!pickId) continue;

        dayObj[meal] = { dishId: pickId, servings: 1 };
        usedWeek.add(pickId);
      }
    }

    saveState();
    toast(onlyEmpty ? "Filled empty meals" : "Filled all meals");
    renderWeek();
  }

  // “Shuffle week” = randomize everything (not macro-smart)
  function shuffleWeek(){
    const plan = ensureWeekPlan();
    const ids = shuffleArray(state.dishes.map(d=>d.id));
    if (ids.length === 0) return toast("Add dishes first");

    let i = 0;
    for (const day of DAYS) {
      for (const meal of MEALS) {
        plan[day][meal] = { dishId: ids[i % ids.length], servings: 1 };
        i++;
      }
    }
    saveState();
    toast("Shuffled week");
    renderWeek();
  }

  // ---- export / copy ----
  function copyPlan(){
    const plan = ensureWeekPlan();
    const tar = state.targets || { cal:0, protein:0, carbs:0, fat:0 };
    const header =
      `Meal plan — ${fmtRange(weekStart)}\n` +
      `Targets: ${tar.cal||0} kcal, ${tar.protein||0}g P, ${tar.carbs||0}g C, ${tar.fat||0}g F\n\n`;

    const text = header + DAYS.map((day, idx) => {
      const date = toISO(addDays(weekStart, idx));
      const dayObj = plan[day];
      const tot = dayTotals(dayObj);
      const st = dayStatus(tot);

      const mealLines = MEALS.map(meal => {
        const e = dayObj[meal];
        const d = e?.dishId ? getDish(e.dishId) : null;
        const name = d ? d.name : "(empty)";
        const s = Number(e?.servings ?? 1) || 0;
        const cal = d ? Math.round((Number(d.cal)||0) * s) : 0;
        const p = d ? Math.round((Number(d.protein)||0) * s) : 0;
        const c = d ? Math.round((Number(d.carbs)||0) * s) : 0;
        const f = d ? Math.round((Number(d.fat)||0) * s) : 0;
        return `  - ${meal}: ${name} — ${s} serving(s) — ${cal} kcal, ${p}P ${c}C ${f}F`;
      }).join("\n");

      return `${day} (${date}) — Total: ${Math.round(tot.cal)} kcal, ${Math.round(tot.protein)}P ${Math.round(tot.carbs)}C ${Math.round(tot.fat)}F — ${st.icon} ${st.label}\n${mealLines}`;
    }).join("\n\n");

    navigator.clipboard?.writeText(text).then(()=>toast("Copied")).catch(()=>toast("Couldn't copy"));
  }

  function exportWeekCSV(){
    const plan = ensureWeekPlan();
    const rows = [["day","date","meal","dish","servings","calories","protein_g","carbs_g","fat_g"]];
    DAYS.forEach((day, idx) => {
      const date = toISO(addDays(weekStart, idx));
      MEALS.forEach(meal => {
        const e = plan[day][meal];
        const d = e?.dishId ? getDish(e.dishId) : null;
        const name = d ? d.name : "";
        const s = Number(e?.servings ?? 1) || 0;
        const cal = d ? (Number(d.cal)||0) * s : 0;
        const p = d ? (Number(d.protein)||0) * s : 0;
        const c = d ? (Number(d.carbs)||0) * s : 0;
        const f = d ? (Number(d.fat)||0) * s : 0;
        rows.push([day, date, meal, name, s, Math.round(cal), Math.round(p), Math.round(c), Math.round(f)]);
      });
      const tot = dayTotals(plan[day]);
      rows.push([day, date, "TOTAL", "", "", Math.round(tot.cal), Math.round(tot.protein), Math.round(tot.carbs), Math.round(tot.fat)]);
    });

    const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type:"text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `meal-plan-${toISO(weekStart)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ---- import ----
  function importBulkCSV(){
    const text = elBulk.value || "";
    const lines = text.split("\n").map(l=>l.trim()).filter(Boolean);
    if (lines.length === 0) return toast("No lines");

    let added=0, skipped=0;
    for (const line of lines) {
      const parts = line.split(",").map(p=>p.trim());
      if (parts.length < 4) { skipped++; continue; }
      const name = normalizeName(parts[0]);
      if (!name) { skipped++; continue; }

      const cal = Number(parts[1]) || 0;
      const protein = Number(parts[2]) || 0;
      const carbs = Number(parts[3]) || 0;
      const fat = Number(parts[4]) || 0;

      if (state.dishes.some(d=>d.name.toLowerCase()===name.toLowerCase())) { skipped++; continue; }
      state.dishes.push({ id: crypto.randomUUID(), name, cal, protein, carbs, fat });
      added++;
    }

    saveState();
    elBulk.value = "";
    toast(`Imported ${added}, skipped ${skipped}`);
    renderDishList();
  }

  // ---- wiring ----
  document.getElementById("saveTargets").addEventListener("click", saveTargets);

  document.getElementById("saveDish").addEventListener("click", saveDishFromForm);
  elDishName.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); saveDishFromForm(); } });

  document.getElementById("importBulk").addEventListener("click", importBulkCSV);

  elSearch.addEventListener("input", renderDishList);
  document.getElementById("clearSearch").addEventListener("click", ()=>{ elSearch.value=""; renderDishList(); elSearch.focus(); });

  document.getElementById("fillEmpty").addEventListener("click", ()=>fillWeek({onlyEmpty:true, smart:true}));
  document.getElementById("shuffleWeek").addEventListener("click", shuffleWeek);
  document.getElementById("copyPlan").addEventListener("click", copyPlan);
  document.getElementById("exportCSV").addEventListener("click", exportWeekCSV);

  document.getElementById("prevWeek").addEventListener("click", ()=>{ weekStart = addDays(weekStart,-7); render(); });
  document.getElementById("nextWeek").addEventListener("click", ()=>{ weekStart = addDays(weekStart, 7); render(); });

  pickSearch.addEventListener("input", renderPicker);
  document.getElementById("pickClear").addEventListener("click", ()=>{ pickSearch.value=""; renderPicker(); pickSearch.focus(); });
  document.getElementById("closePicker").addEventListener("click", ()=> dlg.close());
  document.getElementById("clearMeal").addEventListener("click", clearActiveMeal);

  document.getElementById("reset").addEventListener("click", ()=>{
    if (!confirm("Reset dishes, targets, and all saved plans on this device?")) return;
    localStorage.removeItem(KEY);
    state = defaultState();
    weekStart = startOfWeek(new Date());
    saveState();
    toast("Reset");
    render();
  });

  // ---- picker helpers ----
  function openPicker(day, meal){
    activeDay = day;
    activeMeal = meal;
    pickTitle.textContent = `Pick for ${day} — ${meal}`;
    pickSearch.value = "";
    const plan = ensureWeekPlan();
    servingsInput.value = plan[day][meal]?.servings ?? 1;
    renderPicker();
    dlg.showModal();
    pickSearch.focus();
  }

  function clearActiveMeal(){
    if (!activeDay || !activeMeal) return;
    const plan = ensureWeekPlan();
    plan[activeDay][activeMeal] = emptyMeal();
    saveState();
    dlg.close();
    toast("Cleared");
    renderWeek();
  }

  // ---- initial render ----
  render();
})();
</script>
</body>
</html>
