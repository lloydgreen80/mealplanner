<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meal Planner ‚Äî Macros</title>
  <meta name="theme-color" content="#0b1224" />
  <style>
    :root{
      --bg: #f6f7fb;
      --surface: rgba(255,255,255,.92);
      --card: rgba(255,255,255,.92);
      --text: #111827;
      --muted: #6b7280;
      --border: rgba(17,24,39,.10);
      --shadow: 0 10px 30px rgba(17,24,39,.08);

      --good1: #16a34a;
      --good2: #22c55e;
      --warn1: #f59e0b;
      --warn2: #fbbf24;
      --bad1: #dc2626;
      --bad2: #ef4444;
    }

    [data-theme="dark"]{
      --bg: #07101b;
      --surface: rgba(11,18,36,.55);
      --card: rgba(13,21,34,.90);
      --text: #e6eef6;
      --muted: #9ca3af;
      --border: #172033;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    * { box-sizing: border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(180deg, var(--bg), color-mix(in srgb, var(--bg) 86%, #000 14%));
      color: var(--text);
    }

    header{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background: var(--surface);
      position:sticky;
      top:0;
      backdrop-filter: blur(10px);
      z-index:5;
    }

    main{ padding:16px; max-width:1150px; margin:0 auto; display:grid; gap:14px; }
    .grid{ display:grid; gap:14px; grid-template-columns: 1.25fr .75fr; }
    @media (max-width:920px){ .grid{ grid-template-columns:1fr } }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow: var(--shadow);
    }

    h1{ margin:0; font-size:18px; }
    h2{ margin:0 0 10px; font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; }

    .row{ display:flex; gap:10px; align-items:center; }
    input, textarea, button{
      font:inherit;
      color:var(--text);
      background:transparent;
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
    }
    input::placeholder, textarea::placeholder{ color: color-mix(in srgb, var(--muted) 80%, transparent 20%); }
    input[type=number]{ max-width:140px; }

    button{ cursor:pointer; }
    button.primary{
      background: linear-gradient(135deg,var(--good1),var(--good2));
      border-color: color-mix(in srgb, var(--good2) 30%, transparent 70%);
      color: color-mix(in srgb, var(--text) 10%, #000 90%);
      font-weight:700;
    }

    .muted{ color:var(--muted); font-size:12px; }
    .micro{ font-size:12px; color:var(--muted); }
    .smallBtn{ padding:6px 8px; border-radius:8px; }
    .danger{
      border-color: color-mix(in srgb, var(--bad2) 30%, transparent 70%);
      color: color-mix(in srgb, var(--bad2) 55%, var(--text) 45%);
    }

    .week{ display:grid; gap:12px; }

    .dayCard{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 96%, #000 4%), transparent);
      display:grid;
      gap:10px;
    }

    .dayHeader{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }

    .dayTitle{ display:flex; gap:10px; align-items:flex-start; }
    .dayTitle strong{ font-size:14px; }
    .dayTitle .micro{ margin-top:2px; }

    .dayActions{ display:flex; gap:8px; align-items:center; }
    .iconBtn{
      width:32px; height:32px;
      display:inline-flex; align-items:center; justify-content:center;
      padding:0;
      border-radius:10px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 92%, #000 8%);
      cursor:pointer;
    }
    .iconBtn.danger{
      border-color: color-mix(in srgb, var(--bad2) 35%, var(--border) 65%);
      color: color-mix(in srgb, var(--bad2) 70%, var(--text) 30%);
    }

    .totalsBox{ text-align:right; min-width:240px; }
    .totalsBox .kcal{ font-size:15px; font-weight:800; }

    /* Compact macro bars: 2x2 */
    .progressWrap{
      margin-top:8px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px 10px;
    }
    .progItem{
      display:grid;
      grid-template-columns: 46px 1fr;
      gap:8px;
      align-items:center;
    }
    .progLabel{
      font-size:12px;
      color:var(--muted);
    }
    .bar{
      height:8px;
      border-radius:999px;
      border:1px solid var(--border);
      overflow:hidden;
      background: color-mix(in srgb, var(--card) 92%, #000 8%);
    }
    .fill{
      height:100%;
      width:0%;
      border-radius:999px;
    }
    .fill.green{ background: linear-gradient(135deg,var(--good1),var(--good2)); }
    .fill.amber{ background: linear-gradient(135deg,var(--warn1),var(--warn2)); }
    .fill.red{ background: linear-gradient(135deg,var(--bad1),var(--bad2)); }
    .fill.neutral{ background: color-mix(in srgb, var(--muted) 35%, transparent 65%); }

    .meals{ display:grid; gap:8px; }
    .mealRow{
      display:grid;
      grid-template-columns: 110px 1fr auto auto;
      gap:8px;
      align-items:center;
      padding:10px;
      border:1px solid var(--border);
      border-radius:12px;
      background: color-mix(in srgb, var(--card) 90%, #000 10%);
    }
    .mealRow.dragOver{ outline:2px dashed color-mix(in srgb, var(--good2) 55%, transparent 45%); outline-offset:2px; }
    .mealRow[draggable="true"]{ cursor: grab; }
    .mealRow:active{ cursor: grabbing; }
    @media (max-width:640px){
      .mealRow{ grid-template-columns: 98px 1fr auto; grid-auto-rows:auto; }
      .mealRow .mealMacros{ grid-column: 2 / 3; justify-self:start; }
      .mealRow .mealBtn{ grid-column: 3 / 4; justify-self:end; }
    }

    .dishBlock{ display:flex; flex-direction:column; gap:2px; }
    .dishName{ font-size:14px; font-weight:800; line-height:1.2; }
    .dishLoc{ font-size:12px; font-style:italic; color:var(--muted); line-height:1.2; }
    .dishEmpty{ color: color-mix(in srgb, var(--muted) 85%, transparent 15%); font-weight:600; }

    .list{ display:flex; flex-direction:column; gap:8px; max-height:320px; overflow:auto; padding-right:4px; }
    .dish{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:8px; border-radius:10px; border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 96%, #000 4%);
    }
    .dish[draggable="true"]{ cursor: grab; }
    .dish small{ color:var(--muted); font-size:12px; margin-left:6px; }

    dialog{ border:none; border-radius:12px; padding:0; width:min(760px, 96vw); background:var(--card); color:var(--text); box-shadow: var(--shadow); }
    dialog::backdrop{ background:rgba(0,0,0,.45); }
    .dlg{ padding:14px; }
    .footer{ display:flex; justify-content:space-between; gap:10px; margin-top:10px; flex-wrap:wrap; }

    .targetsGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:520px){ .targetsGrid{ grid-template-columns:1fr; } }
    .targetsGrid label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .targetsGrid .field{ display:flex; flex-direction:column; }

    .hintBox{
      margin-top:10px;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 94%, #000 6%);
      color:var(--muted);
      font-size:12px;
    }

    .headerRight{ margin-left:auto; display:flex; gap:8px; align-items:center; }
    .toggleBtn{ display:flex; gap:8px; align-items:center; }
    .toggleDot{
      width:34px; height:20px; border-radius:999px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 92%, #000 8%);
      position:relative;
    }
    .toggleDot::after{
      content:"";
      position:absolute; top:50%; transform:translateY(-50%);
      left:2px; width:16px; height:16px; border-radius:999px;
      background: linear-gradient(135deg,var(--good1),var(--good2));
      transition: left .18s ease;
    }
    [data-theme="dark"] .toggleDot::after{ left:16px; }

    .checkRow{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .checkRow label{ display:flex; align-items:center; gap:6px; font-size:12px; color:var(--muted); }
    .checkRow input{ width:16px; height:16px; }

    .toastWarn { border-color: color-mix(in srgb, var(--warn2) 40%, var(--border) 60%) !important; }

    /* Weather display */
    .weatherPill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 92%, #000 8%);
      padding:6px 8px;
      border-radius:999px;
      margin-left:8px;
      white-space:nowrap;
    }
    .weatherIcon{ font-size:14px; }
    .weatherTemp{ font-size:12px; color:var(--muted); }
  </style>
</head>

<body>
  <header>
    <div class="row" style="gap:12px;">
      <div>
        <h1>Meal Planner ‚Äî Macros</h1>
        <div class="micro">Drag dishes onto meals, or drag meals to swap. Auto-fill uses categories and avoids duplicates per day.</div>
      </div>

      <div class="headerRight">
        <button id="clearWeek" class="smallBtn danger" type="button" title="Clear all days in this week">Clear week</button>

        <button id="themeToggle" class="smallBtn toggleBtn" type="button" aria-label="Toggle light/dark">
          <span class="micro" id="themeLabel">Light</span>
          <span class="toggleDot" aria-hidden="true"></span>
        </button>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <h2>Week plan</h2>

        <div class="row" style="justify-content:space-between; margin-bottom:10px; flex-wrap:wrap;">
          <div class="row">
            <button class="smallBtn" id="prevWeek">‚Üê</button>
            <button class="smallBtn" id="nextWeek">‚Üí</button>
            <div class="muted" id="weekRange" style="margin-left:10px;"></div>
          </div>

          <div class="row" style="flex-wrap:wrap;">
            <button id="fillEmpty" class="smallBtn">Fill empty meals (smart)</button>
            <button id="shuffleWeek" class="smallBtn">Shuffle week</button>
            <button class="primary" id="copyPlan">Copy plan</button>
            <button id="exportCSV" class="smallBtn">Export CSV</button>
          </div>
        </div>

        <div class="week" id="week"></div>

        <div class="hintBox">
          Bar colouring: under target = amber, exact target = green, any over target = red.
          <br>Weather: set a location in the sidebar (use GPS or search a city). Display shows daily icon + max/min ¬∞C.
        </div>
      </section>

      <aside class="card">
        <h2>Daily targets</h2>
        <div class="targetsGrid" style="margin-bottom:10px;">
          <div class="field">
            <label for="tCal">Calories (kcal)</label>
            <input id="tCal" type="number" min="0" step="10" placeholder="e.g. 2200" />
          </div>
          <div class="field">
            <label for="tProtein">Protein (g)</label>
            <input id="tProtein" type="number" min="0" step="1" placeholder="e.g. 160" />
          </div>
          <div class="field">
            <label for="tCarbs">Carbs (g)</label>
            <input id="tCarbs" type="number" min="0" step="1" placeholder="e.g. 220" />
          </div>
          <div class="field">
            <label for="tFat">Fat (g)</label>
            <input id="tFat" type="number" min="0" step="1" placeholder="e.g. 70" />
          </div>
        </div>
        <div class="row" style="justify-content:space-between; margin-bottom:14px;">
          <div class="muted">Used by smart fill + daily bars.</div>
          <button id="saveTargets" class="smallBtn">Save targets</button>
        </div>

        <h2>Weather</h2>
        <div style="display:grid; gap:8px; margin-bottom:14px;">
          <div class="row" style="justify-content:space-between; flex-wrap:wrap;">
            <label class="muted" style="display:flex; gap:8px; align-items:center;">
              <input id="showWeather" type="checkbox" style="width:16px;height:16px;" />
              Show weather on days
            </label>
            <button id="useMyLocation" class="smallBtn">Use my location</button>
          </div>

          <div class="row">
            <input id="locationQuery" placeholder="Search a place (e.g. London)" style="flex:1;" />
            <button id="findLocation" class="smallBtn">Find</button>
          </div>

          <div class="muted" id="locationStatus">No location set.</div>
        </div>

        <h2>Dishes & Macros</h2>
        <div style="margin-bottom:10px;">
          <div style="display:grid; gap:8px;">
            <input id="dishName" placeholder="Dish name" />

            <div class="row" style="flex-wrap:wrap;">
              <input id="dishCal" placeholder="Calories (kcal)" type="number" min="0" />
              <input id="dishProtein" placeholder="Protein (g)" type="number" min="0" />
              <input id="dishCarbs" placeholder="Carbs (g)" type="number" min="0" />
              <input id="dishFat" placeholder="Fat (g)" type="number" min="0" />
            </div>

            <div class="row" style="flex-wrap:wrap;">
              <input id="dishBook" placeholder="Recipe book (optional)" style="flex:1;" />
              <input id="dishPage" placeholder="Page" type="number" style="width:96px;" min="1" />
            </div>

            <div class="checkRow">
              <span class="muted">Categories:</span>
              <label><input type="checkbox" id="catBreakfast"> Breakfast</label>
              <label><input type="checkbox" id="catLunch"> Lunch</label>
              <label><input type="checkbox" id="catDinner"> Dinner</label>
              <button class="primary" id="saveDish" style="margin-left:auto;">Save</button>
            </div>

            <div class="muted">
              Import format:
              <b>name, cal, protein, carbs, fat, book, page, breakfast, lunch, dinner</b>
            </div>
          </div>
        </div>

        <details style="margin-bottom:10px;">
          <summary class="muted" style="cursor:pointer;">Import CSV (one per line)</summary>
          <div style="margin-top:10px;">
            <textarea id="bulk" placeholder="Example: Pasta bake,650,25,80,18,Everyday Meals,45,0,1,1" style="width:100%; min-height:96px;"></textarea>
            <div class="row" style="justify-content:space-between; margin-top:8px;">
              <span class="muted">Format: name, cal, protein, carbs, fat, book, page, b, l, d</span>
              <button id="importBulk" class="smallBtn">Import</button>
            </div>
          </div>
        </details>

        <div class="row" style="margin-bottom:10px;">
          <input id="search" placeholder="Search dishes‚Ä¶" style="flex:1;" />
          <button id="clearSearch" class="smallBtn">‚úï</button>
        </div>

        <div class="list" id="dishList"></div>

        <div style="display:flex; justify-content:space-between; margin-top:10px;">
          <span class="muted" id="count"></span>
          <button id="reset" class="danger smallBtn">Reset</button>
        </div>
      </aside>
    </div>
  </main>

  <dialog id="picker">
    <div class="dlg">
      <h3 id="pickTitle">Pick a dish</h3>

      <div class="row" style="margin:8px 0;">
        <input id="pickSearch" placeholder="Search‚Ä¶" style="flex:1;" />
        <button class="smallBtn" id="pickClear">‚úï</button>
      </div>

      <div class="list" id="pickList"></div>

      <div class="footer" style="align-items:center;">
        <div class="muted">Macros are per serving.</div>
        <div class="row" style="gap:8px;">
          <button id="clearMeal" class="danger smallBtn">Clear meal</button>
          <button id="closePicker" class="smallBtn">Close</button>
        </div>
      </div>
    </div>
  </dialog>

<script>
(() => {
  const DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
  const MEALS = ["Breakfast","Lunch","Dinner"];
  const KEY = "mealPlanner.macro.v9";
  const THEME_KEY = "mealPlanner.theme";

  function defaultState() {
    return {
      targets: { cal: 2200, protein: 160, carbs: 220, fat: 70 },
      dishes: [
        { id: crypto.randomUUID(), name: "Pasta bake", cal: 650, protein: 25, carbs: 80, fat: 18, book: "Everyday Meals", page: 45, categories: { Breakfast:false, Lunch:true, Dinner:true } },
        { id: crypto.randomUUID(), name: "Overnight oats", cal: 420, protein: 18, carbs: 55, fat: 12, book: "Breakfast Club", page: 12, categories: { Breakfast:true, Lunch:false, Dinner:false } },
        { id: crypto.randomUUID(), name: "Chicken & rice", cal: 520, protein: 40, carbs: 55, fat: 10, book: "", page: null, categories: { Breakfast:false, Lunch:true, Dinner:true } }
      ],
      planByWeekStart: {},
      weather: {
        enabled: false,
        locationName: "",
        lat: null,
        lon: null,
        tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "auto",
        // cache keyed by weekStart ISO
        cacheByWeek: {}
      }
    };
  }

  function loadState() {
    const tryKeys = [KEY, "mealPlanner.macro.v8", "mealPlanner.macro.v7", "mealPlanner.macro.v6", "mealPlanner.macro.v5"];
    for (const k of tryKeys) {
      const raw = localStorage.getItem(k);
      if (!raw) continue;
      try {
        const parsed = JSON.parse(raw);
        if (!parsed.dishes || !parsed.planByWeekStart) continue;

        if (!parsed.targets) parsed.targets = defaultState().targets;

        parsed.dishes = parsed.dishes.map(d => ({
          book: "",
          page: null,
          categories: { Breakfast:true, Lunch:true, Dinner:true },
          ...d,
          categories: { Breakfast:true, Lunch:true, Dinner:true, ...(d.categories || {}) }
        }));
        parsed.targets = { fat: 0, ...parsed.targets };

        if (!parsed.weather) parsed.weather = defaultState().weather;
        parsed.weather = { ...defaultState().weather, ...parsed.weather };

        // ensure plan structure
        for (const wk of Object.keys(parsed.planByWeekStart)) {
          for (const day of DAYS) {
            if (!parsed.planByWeekStart[wk][day]) parsed.planByWeekStart[wk][day] = {};
            for (const meal of MEALS) {
              const e = parsed.planByWeekStart[wk][day][meal];
              if (!e) parsed.planByWeekStart[wk][day][meal] = { dishId: null, servings: 1 };
              if (parsed.planByWeekStart[wk][day][meal].servings == null) parsed.planByWeekStart[wk][day][meal].servings = 1;
            }
          }
        }

        localStorage.setItem(KEY, JSON.stringify(parsed));
        return parsed;
      } catch {}
    }
    return defaultState();
  }

  function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  let state = loadState();

  // ---------- Theme ----------
  function getSystemTheme(){
    return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  }
  function getTheme(){
    return localStorage.getItem(THEME_KEY) || getSystemTheme();
  }
  function setTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem(THEME_KEY, theme);
    document.getElementById("themeLabel").textContent = theme === "dark" ? "Dark" : "Light";
  }
  setTheme(getTheme());
  document.getElementById("themeToggle").addEventListener("click", () => {
    const current = getTheme();
    setTheme(current === "dark" ? "light" : "dark");
  });

  // ---------- Dates ----------
  function formatDate(dateObj){
    try{
      return new Intl.DateTimeFormat(undefined, { day:"2-digit", month:"2-digit", year:"numeric" }).format(dateObj);
    } catch {
      const d = String(dateObj.getDate()).padStart(2,"0");
      const m = String(dateObj.getMonth()+1).padStart(2,"0");
      const y = dateObj.getFullYear();
      return `${d}/${m}/${y}`;
    }
  }

  function startOfWeek(date) {
    const d = new Date(date);
    d.setHours(0,0,0,0);
    const day = (d.getDay() + 6) % 7; // Monday start
    d.setDate(d.getDate() - day);
    return d;
  }
  function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
  function toISO(d){ const x = new Date(d); x.setHours(0,0,0,0); return x.toISOString().slice(0,10); }
  function fmtRange(ws){
    const a = new Date(ws), b = addDays(a,6);
    const opts = { day:"2-digit", month:"short" };
    return `${a.toLocaleDateString(undefined,opts)} ‚Äì ${b.toLocaleDateString(undefined,opts)} ${a.getFullYear()}`;
  }

  let weekStart = startOfWeek(new Date());

  function emptyMeal(){ return { dishId: null, servings: 1 }; }
  function emptyDay(){ const obj = {}; MEALS.forEach(m => obj[m] = emptyMeal()); return obj; }

  function ensureWeekPlan(ws=weekStart){
    const key = toISO(ws);
    if (!state.planByWeekStart[key]) {
      state.planByWeekStart[key] = Object.fromEntries(DAYS.map(d => [d, emptyDay()]));
      saveState();
    } else {
      DAYS.forEach(day => {
        if (!state.planByWeekStart[key][day]) state.planByWeekStart[key][day] = emptyDay();
        MEALS.forEach(meal => {
          if (!state.planByWeekStart[key][day][meal]) state.planByWeekStart[key][day][meal] = emptyMeal();
        });
      });
    }
    return state.planByWeekStart[key];
  }

  // ---------- DOM ----------
  const elWeek = document.getElementById("week");
  const elWeekRange = document.getElementById("weekRange");
  const elDishList = document.getElementById("dishList");
  const elCount = document.getElementById("count");
  const elSearch = document.getElementById("search");

  const elDishName = document.getElementById("dishName");
  const elDishCal = document.getElementById("dishCal");
  const elDishProtein = document.getElementById("dishProtein");
  const elDishCarbs = document.getElementById("dishCarbs");
  const elDishFat = document.getElementById("dishFat");
  const elDishBook = document.getElementById("dishBook");
  const elDishPage = document.getElementById("dishPage");
  const catBreakfast = document.getElementById("catBreakfast");
  const catLunch = document.getElementById("catLunch");
  const catDinner = document.getElementById("catDinner");
  const elBulk = document.getElementById("bulk");

  const tCal = document.getElementById("tCal");
  const tProtein = document.getElementById("tProtein");
  const tCarbs = document.getElementById("tCarbs");
  const tFat = document.getElementById("tFat");

  const dlg = document.getElementById("picker");
  const pickTitle = document.getElementById("pickTitle");
  const pickSearch = document.getElementById("pickSearch");
  const pickList = document.getElementById("pickList");

  // Weather UI
  const showWeather = document.getElementById("showWeather");
  const useMyLocation = document.getElementById("useMyLocation");
  const locationQuery = document.getElementById("locationQuery");
  const findLocation = document.getElementById("findLocation");
  const locationStatus = document.getElementById("locationStatus");

  let activeDay = null;
  let activeMeal = null;

  function toast(msg, kind="info"){
    let el = document.getElementById("__toast");
    if (!el) {
      el = document.createElement("div");
      el.id="__toast";
      el.style.cssText = `
        position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
        background: color-mix(in srgb, var(--card) 96%, #000 4%);
        padding:10px 14px;border-radius:999px;border:1px solid var(--border);
        box-shadow: var(--shadow);font-size:13px;color:var(--text);z-index:9999;
        opacity:0;transition:opacity .15s;`;
      document.body.appendChild(el);
    }
    el.classList.remove("toastWarn");
    if (kind === "warn") el.classList.add("toastWarn");
    el.textContent = msg;
    el.style.opacity = "1";
    setTimeout(()=> el.style.opacity="0", 1800);
  }

  function normalizeName(s){ return (s||"").trim().replace(/\s+/g," "); }
  function getDish(id){ return state.dishes.find(d => d.id === id) || null; }

  function dishLocation(d){
    if (!d) return "";
    const book = (d.book || "").trim();
    const page = d.page != null && d.page !== "" ? String(d.page) : "";
    if (!book && !page) return "";
    if (book && page) return `${book} ‚Ä¢ p.${page}`;
    if (book) return book;
    return `p.${page}`;
  }

  function filteredDishes(q){
    const s=(q||"").trim().toLowerCase();
    const arr=[...state.dishes].sort((a,b)=>a.name.localeCompare(b.name));
    if (!s) return arr;
    return arr.filter(d =>
      d.name.toLowerCase().includes(s) ||
      (d.book||"").toLowerCase().includes(s)
    );
  }

  function clearDishForm(){
    elDishName.value = "";
    elDishCal.value = "";
    elDishProtein.value = "";
    elDishCarbs.value = "";
    elDishFat.value = "";
    elDishBook.value = "";
    elDishPage.value = "";
    catBreakfast.checked = true;
    catLunch.checked = true;
    catDinner.checked = true;
    elDishName.dataset.editing = "";
  }

  function dayTotals(dayObj){
    let cal=0, protein=0, carbs=0, fat=0;
    MEALS.forEach(meal => {
      const entry = dayObj[meal];
      if (!entry?.dishId) return;
      const d = getDish(entry.dishId);
      if (!d) return;
      cal += (Number(d.cal)||0);
      protein += (Number(d.protein)||0);
      carbs += (Number(d.carbs)||0);
      fat += (Number(d.fat)||0);
    });
    return { cal, protein, carbs, fat };
  }

  // Macro colour rule:
  // under target => amber
  // exact target => green
  // any over target => red
  function macroClass(actual, target){
    if (!target || target <= 0) return "neutral";
    if (actual > target) return "red";
    if (actual === target) return "green";
    return "amber";
  }

  function macroFillPct(actual, target){
    if (!target || target <= 0) return 0;
    return Math.max(0, Math.min(130, (actual / target) * 100));
  }

  function macroProgressHTML(tot){
    const tar = state.targets || {};
    const rows = [
      { label:"kcal", a:tot.cal, t:tar.cal },
      { label:"P",    a:tot.protein, t:tar.protein },
      { label:"C",    a:tot.carbs, t:tar.carbs },
      { label:"F",    a:tot.fat, t:tar.fat },
    ];

    return `
      <div class="progressWrap">
        ${rows.map(r => {
          const cls = macroClass(r.a, r.t);
          const pct = macroFillPct(r.a, r.t);
          const label = r.t ? `${Math.round(r.a)}/${Math.round(r.t)}` : `${Math.round(r.a)}/‚Äì`;
          return `
            <div class="progItem" title="${r.label}: ${label}">
              <div class="progLabel">${r.label}</div>
              <div class="bar">
                <div class="fill ${cls}" style="width:${pct.toFixed(1)}%;"></div>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  function dishesForMeal(meal){
    return state.dishes.filter(d => !!d.categories?.[meal]);
  }

  function hasTargets(){
    const tar = state.targets || {};
    return (tar.cal||0) > 0 || (tar.protein||0) > 0 || (tar.carbs||0) > 0 || (tar.fat||0) > 0;
  }

  // smart fill score
  function scoreAgainstTargets(tot){
    const tar = state.targets || { cal:0, protein:0, carbs:0, fat:0 };
    if (!hasTargets()) return 0;

    function term(actual, target){
      if (!target || target <= 0) return 0;
      const diff = (actual - target) / target;
      return diff * diff;
    }

    const wCal = 1.0, wProtein = 1.4, wCarbs = 1.1, wFat = 1.1;
    return (
      wCal * term(tot.cal, tar.cal) +
      wProtein * term(tot.protein, tar.protein) +
      wCarbs * term(tot.carbs, tar.carbs) +
      wFat * term(tot.fat, tar.fat)
    );
  }

  function dayTotalsIfAddDish(dayObj, dish){
    const t = dayTotals(dayObj);
    return {
      cal: t.cal + (Number(dish.cal)||0),
      protein: t.protein + (Number(dish.protein)||0),
      carbs: t.carbs + (Number(dish.carbs)||0),
      fat: t.fat + (Number(dish.fat)||0),
    };
  }

  function smartPickDishForMeal(dayObj, meal, usedDayIds){
    const primary = dishesForMeal(meal).filter(d => !usedDayIds.has(d.id));
    const fallback = state.dishes.filter(d => !usedDayIds.has(d.id));
    const pool = primary.length ? primary : fallback;
    if (!pool.length) return null;

    if (!hasTargets()){
      return pool[Math.floor(Math.random()*pool.length)].id;
    }

    let best = null;
    let bestScore = Infinity;
    for (const d of pool) {
      const candidateTotals = dayTotalsIfAddDish(dayObj, d);
      const s = scoreAgainstTargets(candidateTotals);
      if (s < bestScore) { bestScore = s; best = d; }
    }
    return best?.id ?? null;
  }

  // ---------- Weather ----------
  // Open-Meteo weather codes mapping (simplified to emoji)
  function weatherEmoji(code){
    // See: https://open-meteo.com/en/docs (weathercode)
    if (code === 0) return "‚òÄÔ∏è";
    if (code === 1) return "üå§Ô∏è";
    if (code === 2) return "‚õÖ";
    if (code === 3) return "‚òÅÔ∏è";
    if ([45,48].includes(code)) return "üå´Ô∏è";
    if ([51,53,55,56,57].includes(code)) return "üå¶Ô∏è";
    if ([61,63,65,66,67].includes(code)) return "üåßÔ∏è";
    if ([71,73,75,77].includes(code)) return "üå®Ô∏è";
    if ([80,81,82].includes(code)) return "üåßÔ∏è";
    if ([85,86].includes(code)) return "üå®Ô∏è";
    if ([95,96,99].includes(code)) return "‚õàÔ∏è";
    return "üå°Ô∏è";
  }

  function weatherKeyForCache(){
    const w = state.weather || {};
    const lat = (w.lat ?? "").toString();
    const lon = (w.lon ?? "").toString();
    return `${lat},${lon}`;
  }

  function setLocationStatus(){
    const w = state.weather || {};
    if (w.lat == null || w.lon == null) {
      locationStatus.textContent = "No location set.";
      return;
    }
    const name = w.locationName ? ` (${w.locationName})` : "";
    locationStatus.textContent = `Location: ${w.lat.toFixed(4)}, ${w.lon.toFixed(4)}${name}`;
  }

  async function fetchWeatherForWeek(){
    const w = state.weather;
    if (!w.enabled) return;
    if (w.lat == null || w.lon == null) return;

    const weekIso = toISO(weekStart);
    const cacheKey = `${weekIso}|${weatherKeyForCache()}`;
    if (w.cacheByWeek[cacheKey]) return; // already cached

    const start = new Date(weekStart);
    const end = addDays(start, 6);
    const startStr = toISO(start);
    const endStr = toISO(end);

    const tz = w.tz || "auto";
    const url =
      `https://api.open-meteo.com/v1/forecast` +
      `?latitude=${encodeURIComponent(w.lat)}` +
      `&longitude=${encodeURIComponent(w.lon)}` +
      `&daily=weathercode,temperature_2m_max,temperature_2m_min` +
      `&temperature_unit=celsius` +
      `&timezone=${encodeURIComponent(tz)}` +
      `&start_date=${encodeURIComponent(startStr)}` +
      `&end_date=${encodeURIComponent(endStr)}`;

    try{
      const res = await fetch(url);
      if (!res.ok) throw new Error("Weather fetch failed");
      const data = await res.json();

      const out = {};
      const times = data?.daily?.time || [];
      const codes = data?.daily?.weathercode || [];
      const tmax = data?.daily?.temperature_2m_max || [];
      const tmin = data?.daily?.temperature_2m_min || [];

      for (let i=0;i<times.length;i++){
        out[times[i]] = {
          code: codes[i],
          tmax: tmax[i],
          tmin: tmin[i]
        };
      }

      w.cacheByWeek[cacheKey] = {
        fetchedAt: Date.now(),
        byDateISO: out
      };
      saveState();
    } catch (e){
      toast("Couldn‚Äôt load weather (check internet).", "warn");
    }
  }

  function getWeatherForDate(dateObj){
    const w = state.weather;
    if (!w.enabled) return null;
    if (w.lat == null || w.lon == null) return null;

    const weekIso = toISO(weekStart);
    const cacheKey = `${weekIso}|${weatherKeyForCache()}`;
    const cached = w.cacheByWeek[cacheKey];
    if (!cached) return null;

    const iso = toISO(dateObj);
    return cached.byDateISO?.[iso] || null;
  }

  async function setLocationByGeolocation(){
    if (!navigator.geolocation) {
      toast("Geolocation not supported in this browser.", "warn");
      return;
    }
    toast("Requesting location permission‚Ä¶");
    navigator.geolocation.getCurrentPosition(async (pos) => {
      state.weather.lat = pos.coords.latitude;
      state.weather.lon = pos.coords.longitude;
      state.weather.locationName = "";
      saveState();
      setLocationStatus();
      await fetchWeatherForWeek();
      renderWeek();
      toast("Location set");
    }, (err) => {
      toast("Location permission denied or unavailable.", "warn");
    }, { enableHighAccuracy:false, timeout:10000, maximumAge: 600000 });
  }

  async function setLocationBySearch(query){
    const q = (query || "").trim();
    if (!q) return toast("Enter a place name first", "warn");

    const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=en&format=json`;
    try{
      const res = await fetch(url);
      if (!res.ok) throw new Error("Geo search failed");
      const data = await res.json();
      const r = data?.results?.[0];
      if (!r) return toast("No results found", "warn");

      state.weather.lat = r.latitude;
      state.weather.lon = r.longitude;
      state.weather.locationName = [r.name, r.admin1, r.country].filter(Boolean).join(", ");
      state.weather.tz = r.timezone || state.weather.tz;
      saveState();
      setLocationStatus();
      await fetchWeatherForWeek();
      renderWeek();
      toast("Location set");
    } catch {
      toast("Couldn‚Äôt search location (check internet).", "warn");
    }
  }

  // ---------- Clear helpers ----------
  function clearDay(day){
    const plan = ensureWeekPlan();
    plan[day] = emptyDay();
    saveState();
    renderWeek();
    toast(`${day} cleared`);
  }

  function clearWeek(){
    const plan = ensureWeekPlan();
    DAYS.forEach(d => plan[d] = emptyDay());
    saveState();
    renderWeek();
    toast("Week cleared");
  }

  // ---------- Rendering ----------
  function render(){
    elWeekRange.textContent = fmtRange(weekStart);
    renderTargetsUI();
    renderWeatherUI();
    renderWeek();
    renderDishList();
  }

  function renderTargetsUI(){
    const tar = state.targets || {};
    tCal.value = tar.cal ?? "";
    tProtein.value = tar.protein ?? "";
    tCarbs.value = tar.carbs ?? "";
    tFat.value = tar.fat ?? "";
  }

  function renderWeatherUI(){
    showWeather.checked = !!state.weather.enabled;
    setLocationStatus();
  }

  function renderWeek(){
    const plan = ensureWeekPlan();
    elWeek.innerHTML = "";

    DAYS.forEach((day, idx) => {
      const dateObj = addDays(weekStart, idx);
      const dayObj = plan[day];
      const tot = dayTotals(dayObj);

      const w = getWeatherForDate(dateObj);
      const weatherHTML = (state.weather.enabled && w)
        ? `
          <span class="weatherPill" title="Weather forecast">
            <span class="weatherIcon">${weatherEmoji(w.code)}</span>
            <span class="weatherTemp">${Math.round(w.tmax)}¬∞ / ${Math.round(w.tmin)}¬∞C</span>
          </span>
        `
        : "";

      const wrap = document.createElement("div");
      wrap.className = "dayCard";
      wrap.innerHTML = `
        <div class="dayHeader">
          <div class="dayTitle">
            <div>
              <strong>${day}</strong>
              <div class="micro">${formatDate(dateObj)} ${weatherHTML}</div>
            </div>
            <div class="dayActions">
              <button class="iconBtn danger" data-clear-day="1" title="Clear this day" aria-label="Clear this day">‚úï</button>
            </div>
          </div>

          <div class="totalsBox">
            <div class="kcal">${Math.round(tot.cal)} kcal</div>
            <div class="micro">${Math.round(tot.protein)}g P ‚Ä¢ ${Math.round(tot.carbs)}g C ‚Ä¢ ${Math.round(tot.fat)}g F</div>
            ${macroProgressHTML(tot)}
          </div>
        </div>

        <div class="meals">
          ${MEALS.map(meal => {
            const e = dayObj[meal];
            const d = e?.dishId ? getDish(e.dishId) : null;
            const loc = d ? dishLocation(d) : "";
            const tooltip = d
              ? `${d.name} ‚Äî ${d.cal} kcal, ${d.protein}P, ${d.carbs}C, ${d.fat}F${loc ? " ‚Äî " + loc : ""}`
              : "Drop a dish here or tap Edit";

            const mealCal = d ? (Number(d.cal)||0) : 0;
            const mealP = d ? (Number(d.protein)||0) : 0;
            const mealC = d ? (Number(d.carbs)||0) : 0;
            const mealF = d ? (Number(d.fat)||0) : 0;

            return `
              <div class="mealRow" draggable="true" data-day="${day}" data-meal="${meal}">
                <div class="muted"><strong>${meal}</strong></div>

                <div class="dishBlock" title="${tooltip}">
                  ${d
                    ? `<div class="dishName">${d.name}</div>${loc ? `<div class="dishLoc">${loc}</div>` : ``}`
                    : `<div class="dishName dishEmpty">Drop a dish here or tap Edit</div>`
                  }
                </div>

                <div class="micro mealMacros">
                  ${Math.round(mealCal)} kcal ‚Ä¢ ${Math.round(mealP)}P ${Math.round(mealC)}C ${Math.round(mealF)}F
                </div>

                <div class="mealBtn">
                  <button class="smallBtn" data-edit="1">Edit</button>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;

      // clear day
      wrap.querySelector("[data-clear-day]").addEventListener("click", () => {
        if (!confirm(`Clear all meals for ${day}?`)) return;
        clearDay(day);
      });

      // drag/drop
      wrap.querySelectorAll(".mealRow").forEach(row => {
        row.querySelector("button[data-edit]").addEventListener("click", () => {
          openPicker(row.dataset.day, row.dataset.meal);
        });

        row.addEventListener("dragstart", (ev) => {
          const payload = { type:"mealSlot", day: row.dataset.day, meal: row.dataset.meal };
          ev.dataTransfer.setData("text/plain", JSON.stringify(payload));
          ev.dataTransfer.effectAllowed = "copyMove";
        });

        row.addEventListener("dragover", (ev) => {
          ev.preventDefault();
          row.classList.add("dragOver");
          ev.dataTransfer.dropEffect = "move";
        });

        row.addEventListener("dragleave", () => row.classList.remove("dragOver"));

        row.addEventListener("drop", (ev) => {
          ev.preventDefault();
          row.classList.remove("dragOver");

          const json = ev.dataTransfer.getData("text/plain");
          if (!json) return;

          let payload;
          try { payload = JSON.parse(json); } catch { return; }

          const targetDay = row.dataset.day;
          const targetMeal = row.dataset.meal;
          const plan = ensureWeekPlan();

          if (payload.type === "dish") {
            const dish = getDish(payload.dishId);
            if (dish && dish.categories && dish.categories[targetMeal] === false) {
              toast(`Warning: ‚Äú${dish.name}‚Äù isn‚Äôt tagged for ${targetMeal}`, "warn");
            }
            plan[targetDay][targetMeal] = { dishId: payload.dishId, servings: 1 };
            saveState();
            renderWeek();
            return;
          }

          if (payload.type === "mealSlot") {
            const fromDay = payload.day;
            const fromMeal = payload.meal;
            const a = plan[fromDay][fromMeal];
            const b = plan[targetDay][targetMeal];
            plan[fromDay][fromMeal] = b;
            plan[targetDay][targetMeal] = a;
            saveState();
            renderWeek();
          }
        });
      });

      elWeek.appendChild(wrap);
    });
  }

  function renderDishList(){
    const list = filteredDishes(elSearch.value);
    elDishList.innerHTML = "";

    list.forEach(d => {
      const el = document.createElement("div");
      el.className = "dish";
      el.setAttribute("draggable","true");
      el.dataset.dishId = d.id;

      const loc = dishLocation(d);
      const cats = d.categories || {};
      const catText = ["Breakfast","Lunch","Dinner"].filter(m => cats[m]).join(", ") || "‚Äî";

      el.innerHTML = `
        <div>
          <div>
            <strong>${d.name}</strong>
            <small class="micro">(${d.cal} kcal, ${d.protein}P, ${d.carbs}C, ${d.fat}F)</small>
          </div>
          ${loc ? `<div class="micro"><i>${loc}</i></div>` : ""}
          <div class="micro">Categories: ${catText}</div>
          <div class="micro">Drag onto a meal slot</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="smallBtn" data-edit="${d.id}">Edit</button>
          <button class="smallBtn" data-delete="${d.id}">Delete</button>
        </div>
      `;

      el.addEventListener("dragstart", (ev) => {
        const payload = { type:"dish", dishId: d.id };
        ev.dataTransfer.setData("text/plain", JSON.stringify(payload));
        ev.dataTransfer.effectAllowed = "copyMove";
      });

      el.querySelector("[data-delete]").addEventListener("click", () => deleteDish(d.id));
      el.querySelector("[data-edit]").addEventListener("click", () => editDish(d.id));
      elDishList.appendChild(el);
    });

    elCount.textContent = `${state.dishes.length} dish${state.dishes.length===1? "" : "es"}`;
  }

  // ---------- Dish CRUD ----------
  function saveDishFromForm(){
    const name = normalizeName(elDishName.value);
    if (!name) return toast("Name required");

    const cal = Number(elDishCal.value) || 0;
    const protein = Number(elDishProtein.value) || 0;
    const carbs = Number(elDishCarbs.value) || 0;
    const fat = Number(elDishFat.value) || 0;
    const book = (elDishBook.value || "").trim();
    const pageVal = elDishPage.value ? Number(elDishPage.value) : null;

    const categories = {
      Breakfast: !!catBreakfast.checked,
      Lunch: !!catLunch.checked,
      Dinner: !!catDinner.checked
    };
    if (!categories.Breakfast && !categories.Lunch && !categories.Dinner) {
      categories.Breakfast = categories.Lunch = categories.Dinner = true;
    }

    const editing = elDishName.dataset.editing;
    if (editing) {
      const idx = state.dishes.findIndex(d => d.id === editing);
      if (idx !== -1) {
        state.dishes[idx] = { ...state.dishes[idx], name, cal, protein, carbs, fat, book, page: pageVal, categories };
        saveState();
        toast("Updated");
        clearDishForm();
        render();
        return;
      }
    }

    if (state.dishes.some(d => d.name.toLowerCase() === name.toLowerCase())) {
      return toast("Already exists");
    }

    state.dishes.push({ id: crypto.randomUUID(), name, cal, protein, carbs, fat, book, page: pageVal, categories });
    saveState();
    toast("Saved");
    clearDishForm();
    render();
  }

  function editDish(id){
    const d = getDish(id);
    if (!d) return;
    elDishName.value = d.name;
    elDishCal.value = d.cal;
    elDishProtein.value = d.protein;
    elDishCarbs.value = d.carbs;
    elDishFat.value = d.fat ?? 0;
    elDishBook.value = d.book ?? "";
    elDishPage.value = d.page ?? "";
    catBreakfast.checked = !!d.categories?.Breakfast;
    catLunch.checked = !!d.categories?.Lunch;
    catDinner.checked = !!d.categories?.Dinner;
    elDishName.dataset.editing = d.id;
    elDishName.focus();
  }

  function deleteDish(id){
    if (!confirm("Delete dish? It will be removed from any plans too.")) return;
    state.dishes = state.dishes.filter(x => x.id !== id);

    for (const wk of Object.keys(state.planByWeekStart)) {
      DAYS.forEach(day => {
        MEALS.forEach(meal => {
          const e = state.planByWeekStart[wk]?.[day]?.[meal];
          if (e?.dishId === id) state.planByWeekStart[wk][day][meal] = emptyMeal();
        });
      });
    }

    saveState();
    toast("Deleted");
    render();
  }

  // ---------- Targets ----------
  function saveTargets(){
    state.targets = {
      cal: Number(tCal.value) || 0,
      protein: Number(tProtein.value) || 0,
      carbs: Number(tCarbs.value) || 0,
      fat: Number(tFat.value) || 0
    };
    saveState();
    toast("Targets saved");
    renderWeek();
  }

  // ---------- Picker ----------
  function openPicker(day, meal){
    activeDay = day;
    activeMeal = meal;
    pickTitle.textContent = `Pick for ${day} ‚Äî ${meal}`;
    pickSearch.value = "";
    renderPicker();
    dlg.showModal();
    pickSearch.focus();
  }

  function renderPicker(){
    const list = filteredDishes(pickSearch.value);
    pickList.innerHTML = "";
    if (list.length === 0) {
      const el = document.createElement("div");
      el.className = "muted";
      el.textContent = "No dishes found.";
      pickList.appendChild(el);
      return;
    }

    list.forEach(d => {
      const row = document.createElement("div");
      row.className = "dish";
      const loc = dishLocation(d);
      const cats = d.categories || {};
      const catText = ["Breakfast","Lunch","Dinner"].filter(m => cats[m]).join(", ") || "‚Äî";

      row.innerHTML = `
        <div>
          <div><strong>${d.name}</strong> <small class="micro">(${d.cal} kcal, ${d.protein}P, ${d.carbs}C, ${d.fat}F)</small></div>
          ${loc ? `<div class="micro"><i>${loc}</i></div>` : ""}
          <div class="micro">Categories: ${catText}</div>
        </div>
        <div><button class="smallBtn">Choose</button></div>
      `;

      row.querySelector("button").addEventListener("click", () => {
        const plan = ensureWeekPlan();
        if (d.categories && d.categories[activeMeal] === false) {
          toast(`Warning: ‚Äú${d.name}‚Äù isn‚Äôt tagged for ${activeMeal}`, "warn");
        }
        plan[activeDay][activeMeal] = { dishId: d.id, servings: 1 };
        saveState();
        dlg.close();
        toast("Saved");
        renderWeek();
      });

      pickList.appendChild(row);
    });
  }

  function clearActiveMeal(){
    if (!activeDay || !activeMeal) return;
    const plan = ensureWeekPlan();
    plan[activeDay][activeMeal] = emptyMeal();
    saveState();
    dlg.close();
    toast("Cleared");
    renderWeek();
  }

  // ---------- Auto fill ----------
  function fillWeek({ onlyEmpty=false, smart=true } = {}){
    const plan = ensureWeekPlan();
    if (state.dishes.length === 0) return toast("Add dishes first");

    for (const day of DAYS) {
      const dayObj = plan[day];

      const usedDayIds = new Set();
      for (const meal of MEALS) {
        const existing = dayObj[meal]?.dishId;
        if (existing) usedDayIds.add(existing);
      }

      for (const meal of MEALS) {
        const isEmpty = !dayObj[meal]?.dishId;
        if (onlyEmpty && !isEmpty) continue;

        let pickId = null;
        if (smart) {
          pickId = smartPickDishForMeal(dayObj, meal, usedDayIds);
        } else {
          const primary = dishesForMeal(meal).filter(d => !usedDayIds.has(d.id));
          const fallback = state.dishes.filter(d => !usedDayIds.has(d.id));
          const pool = primary.length ? primary : fallback;
          pickId = pool.length ? pool[Math.floor(Math.random()*pool.length)].id : null;
        }

        if (!pickId) continue;
        dayObj[meal] = { dishId: pickId, servings: 1 };
        usedDayIds.add(pickId);
      }
    }

    saveState();
    toast(onlyEmpty ? "Filled empty meals" : "Filled all meals");
    renderWeek();
  }

  function shuffleWeek(){
    const plan = ensureWeekPlan();
    if (state.dishes.length === 0) return toast("Add dishes first");

    for (const day of DAYS) {
      const usedDayIds = new Set();
      for (const meal of MEALS) {
        const primary = dishesForMeal(meal).filter(d => !usedDayIds.has(d.id));
        const fallback = state.dishes.filter(d => !usedDayIds.has(d.id));
        const pool = primary.length ? primary : fallback;
        if (!pool.length) continue;
        const pick = pool[Math.floor(Math.random()*pool.length)];
        plan[day][meal] = { dishId: pick.id, servings: 1 };
        usedDayIds.add(pick.id);
      }
    }

    saveState();
    toast("Shuffled week");
    renderWeek();
  }

  function copyPlan(){
    const plan = ensureWeekPlan();
    const tar = state.targets || { cal:0, protein:0, carbs:0, fat:0 };
    const header =
      `Meal plan ‚Äî ${fmtRange(weekStart)}\n` +
      `Targets: ${tar.cal||0} kcal, ${tar.protein||0}g P, ${tar.carbs||0}g C, ${tar.fat||0}g F\n\n`;

    const text = header + DAYS.map((day, idx) => {
      const dateObj = addDays(weekStart, idx);
      const dayObj = plan[day];
      const tot = dayTotals(dayObj);

      const mealLines = MEALS.map(meal => {
        const e = dayObj[meal];
        const d = e?.dishId ? getDish(e.dishId) : null;
        const name = d ? d.name : "(empty)";
        const cal = d ? Math.round(Number(d.cal)||0) : 0;
        const p = d ? Math.round(Number(d.protein)||0) : 0;
        const c = d ? Math.round(Number(d.carbs)||0) : 0;
        const f = d ? Math.round(Number(d.fat)||0) : 0;
        const loc = d ? dishLocation(d) : "";
        const locText = loc ? ` ‚Äî ${loc}` : "";
        return `  - ${meal}: ${name}${locText} ‚Äî ${cal} kcal, ${p}P ${c}C ${f}F`;
      }).join("\n");

      return `${day} (${formatDate(dateObj)}) ‚Äî Total: ${Math.round(tot.cal)} kcal, ${Math.round(tot.protein)}P ${Math.round(tot.carbs)}C ${Math.round(tot.fat)}F\n${mealLines}`;
    }).join("\n\n");

    navigator.clipboard?.writeText(text).then(()=>toast("Copied")).catch(()=>toast("Couldn't copy"));
  }

  function exportWeekCSV(){
    const plan = ensureWeekPlan();
    const rows = [["day","date","meal","dish","recipe_book","page","calories","protein_g","carbs_g","fat_g"]];
    DAYS.forEach((day, idx) => {
      const dateObj = addDays(weekStart, idx);
      const dateStr = formatDate(dateObj);

      MEALS.forEach(meal => {
        const e = plan[day][meal];
        const d = e?.dishId ? getDish(e.dishId) : null;
        const name = d ? d.name : "";
        const book = d ? (d.book || "") : "";
        const page = d ? (d.page != null ? d.page : "") : "";
        const cal = d ? (Number(d.cal)||0) : 0;
        const p = d ? (Number(d.protein)||0) : 0;
        const c = d ? (Number(d.carbs)||0) : 0;
        const f = d ? (Number(d.fat)||0) : 0;
        rows.push([day, dateStr, meal, name, book, page, Math.round(cal), Math.round(p), Math.round(c), Math.round(f)]);
      });

      const tot = dayTotals(plan[day]);
      rows.push([day, dateStr, "TOTAL", "", "", "", Math.round(tot.cal), Math.round(tot.protein), Math.round(tot.carbs), Math.round(tot.fat)]);
    });

    const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type:"text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `meal-plan-${toISO(weekStart)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function parseBoolLike(v){
    const s = String(v ?? "").trim().toLowerCase();
    if (!s) return false;
    return ["1","true","yes","y","t"].includes(s);
  }

  function importBulkCSV(){
    const text = elBulk.value || "";
    const lines = text.split("\n").map(l=>l.trim()).filter(Boolean);
    if (lines.length === 0) return toast("No lines");

    let added=0, skipped=0;

    for (const line of lines) {
      const parts = line.split(",").map(p=>p.trim());
      if (parts.length < 5) { skipped++; continue; }

      const name = normalizeName(parts[0]);
      if (!name) { skipped++; continue; }

      const cal = Number(parts[1]) || 0;
      const protein = Number(parts[2]) || 0;
      const carbs = Number(parts[3]) || 0;
      const fat = Number(parts[4]) || 0;

      const book = parts[5] || "";
      const page = parts[6] ? Number(parts[6]) : null;

      let categories = { Breakfast:true, Lunch:true, Dinner:true };
      if (parts.length >= 10) {
        categories = {
          Breakfast: parseBoolLike(parts[7]),
          Lunch: parseBoolLike(parts[8]),
          Dinner: parseBoolLike(parts[9]),
        };
        if (!categories.Breakfast && !categories.Lunch && !categories.Dinner) {
          categories.Breakfast = categories.Lunch = categories.Dinner = true;
        }
      }

      if (state.dishes.some(d=>d.name.toLowerCase()===name.toLowerCase())) { skipped++; continue; }
      state.dishes.push({ id: crypto.randomUUID(), name, cal, protein, carbs, fat, book, page, categories });
      added++;
    }

    saveState();
    elBulk.value = "";
    toast(`Imported ${added}, skipped ${skipped}`);
    renderDishList();
  }

  // ---------- Wire up ----------
  document.getElementById("saveTargets").addEventListener("click", saveTargets);
  document.getElementById("saveDish").addEventListener("click", saveDishFromForm);
  document.getElementById("importBulk").addEventListener("click", importBulkCSV);

  elDishName.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); saveDishFromForm(); } });

  elSearch.addEventListener("input", renderDishList);
  document.getElementById("clearSearch").addEventListener("click", ()=>{ elSearch.value=""; renderDishList(); elSearch.focus(); });

  document.getElementById("fillEmpty").addEventListener("click", ()=>fillWeek({onlyEmpty:true, smart:true}));
  document.getElementById("shuffleWeek").addEventListener("click", shuffleWeek);
  document.getElementById("copyPlan").addEventListener("click", copyPlan);
  document.getElementById("exportCSV").addEventListener("click", exportWeekCSV);

  document.getElementById("prevWeek").addEventListener("click", async ()=>{ weekStart = addDays(weekStart,-7); await fetchWeatherForWeek(); render(); });
  document.getElementById("nextWeek").addEventListener("click", async ()=>{ weekStart = addDays(weekStart, 7); await fetchWeatherForWeek(); render(); });

  pickSearch.addEventListener("input", renderPicker);
  document.getElementById("pickClear").addEventListener("click", ()=>{ pickSearch.value=""; renderPicker(); pickSearch.focus(); });
  document.getElementById("closePicker").addEventListener("click", ()=> dlg.close());
  document.getElementById("clearMeal").addEventListener("click", clearActiveMeal);

  // Clear week button with confirm
  document.getElementById("clearWeek").addEventListener("click", () => {
    const label = fmtRange(weekStart);
    if (!confirm(`Clear ALL days for this week (${label})? This cannot be undone.`)) return;
    const plan = ensureWeekPlan();
    DAYS.forEach(d => plan[d] = emptyDay());
    saveState();
    renderWeek();
    toast("Week cleared");
  });

  document.getElementById("reset").addEventListener("click", ()=>{
    if (!confirm("Reset dishes, targets, and all saved plans on this device?")) return;
    localStorage.removeItem(KEY);
    state = defaultState();
    weekStart = startOfWeek(new Date());
    saveState();
    toast("Reset");
    render();
  });

  // Weather wiring
  showWeather.addEventListener("change", async () => {
    state.weather.enabled = !!showWeather.checked;
    saveState();
    if (state.weather.enabled) {
      await fetchWeatherForWeek();
    }
    renderWeek();
  });

  useMyLocation.addEventListener("click", async () => {
    state.weather.enabled = true;
    showWeather.checked = true;
    saveState();
    await setLocationByGeolocation();
  });

  findLocation.addEventListener("click", async () => {
    state.weather.enabled = true;
    showWeather.checked = true;
    saveState();
    await setLocationBySearch(locationQuery.value);
  });

  locationQuery.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      findLocation.click();
    }
  });

  // default categories for new dish entry
  catBreakfast.checked = true;
  catLunch.checked = true;
  catDinner.checked = true;

  // ---------- Initial render ----------
  (async () => {
    render();
    if (state.weather.enabled) {
      await fetchWeatherForWeek();
      renderWeek();
    }
  })();
})();
</script>
</body>
</html>
