<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meal Planner ‚Äî Macros</title>
  <meta name="theme-color" content="#0b1224" />
  <style>
    :root{
      --bg: #f6f7fb;
      --surface: rgba(255,255,255,.92);
      --card: rgba(255,255,255,.92);
      --text: #111827;
      --muted: #6b7280;
      --border: rgba(17,24,39,.10);
      --shadow: 0 10px 30px rgba(17,24,39,.08);

      --good1: #16a34a;
      --good2: #22c55e;
      --warn1: #f59e0b;
      --warn2: #fbbf24;
      --bad1: #dc2626;
      --bad2: #ef4444;

      --accent1:#2563eb;
      --accent2:#60a5fa;
    }

    [data-theme="dark"]{
      --bg: #07101b;
      --surface: rgba(11,18,36,.55);
      --card: rgba(13,21,34,.90);
      --text: #e6eef6;
      --muted: #9ca3af;
      --border: #172033;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(180deg, var(--bg), color-mix(in srgb, var(--bg) 86%, #000 14%));
      color: var(--text);
    }

    header{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background: var(--surface);
      position:sticky;
      top:0;
      backdrop-filter: blur(10px);
      z-index:50;
    }

    main{
      padding:16px;
      max-width:1150px;
      margin:0 auto;
      display:grid;
      gap:14px;
    }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: .78fr 1.22fr;
      align-items:start;
    }
    @media (max-width:920px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow: var(--shadow);
    }

    @media (min-width: 921px){
      aside.card{
        position: sticky;
        top: 76px;
        align-self: start;
      }
    }

    h1{ margin:0; font-size:18px; }
    h2{ margin:0 0 10px; font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; }

    .row{ display:flex; gap:10px; align-items:center; }
    input, textarea, button{
      font:inherit;
      color:var(--text);
      background:transparent;
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
    }
    input::placeholder, textarea::placeholder{ color: color-mix(in srgb, var(--muted) 80%, transparent 20%); }
    input[type=number]{ max-width:140px; }
    textarea{ width:100%; }
    button{ cursor:pointer; }
    button.primary{
      background: linear-gradient(135deg,var(--good1),var(--good2));
      border-color: color-mix(in srgb, var(--good2) 30%, transparent 70%);
      color: color-mix(in srgb, var(--text) 10%, #000 90%);
      font-weight:700;
    }
    .muted{ color:var(--muted); font-size:12px; }
    .micro{ font-size:12px; color:var(--muted); }
    .smallBtn{ padding:6px 8px; border-radius:8px; }
    .danger{
      border-color: color-mix(in srgb, var(--bad2) 30%, transparent 70%);
      color: color-mix(in srgb, var(--bad2) 55%, var(--text) 45%);
    }

    .headerRight{ margin-left:auto; display:flex; gap:8px; align-items:center; }
    .toggleBtn{ display:flex; gap:8px; align-items:center; }
    .toggleDot{
      width:34px; height:20px; border-radius:999px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 92%, #000 8%);
      position:relative;
    }
    .toggleDot::after{
      content:"";
      position:absolute; top:50%; transform:translateY(-50%);
      left:2px; width:16px; height:16px; border-radius:999px;
      background: linear-gradient(135deg,var(--good1),var(--good2));
      transition: left .18s ease;
    }
    [data-theme="dark"] .toggleDot::after{ left:16px; }

    .iconBtn{
      width:34px; height:34px;
      display:inline-flex; align-items:center; justify-content:center;
      padding:0;
      border-radius:10px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 92%, #000 8%);
      cursor:pointer;
    }

    .week{ display:grid; gap:12px; }
    .dayCard{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 96%, #000 4%), transparent);
      display:grid;
      gap:10px;
      position:relative;
    }
    .dayCard.locked{
      outline:2px solid color-mix(in srgb, var(--accent2) 35%, transparent 65%);
      outline-offset:2px;
    }

    .dayHeader{ display:flex; flex-direction:column; gap:8px; }
    .dayTopRow{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .dayLeft{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .dayLeft strong{ font-size:14px; }
    .dayLeft .micro{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

    .dayRight{ display:flex; align-items:flex-start; gap:10px; flex-shrink:0; }
    .dayTotalsInline{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:140px;
    }
    .dayTotalsInline .kcal{
      font-size:14px;
      font-weight:800;
      color: var(--text);
      line-height:1.1;
    }

    .progressWrap{
      margin-top:4px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:8px;
    }
    .progItem{ display:grid; gap:6px; align-items:center; min-width:0; }
    .progLabel{ font-size:11px; color:var(--muted); line-height:1; text-align:center; }
    .bar{
      width:100%;
      height:10px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid color-mix(in srgb, var(--muted) 28%, var(--border) 72%);
      background: color-mix(in srgb, var(--muted) 14%, var(--card) 86%);
    }
    .fill{ height:100%; display:block; width:0%; border-radius:999px; }
    .fill.green{ background: linear-gradient(135deg,var(--good1),var(--good2)); }
    .fill.amber{ background: linear-gradient(135deg,var(--warn1),var(--warn2)); }
    .fill.red{ background: linear-gradient(135deg,var(--bad1),var(--bad2)); }
    .fill.neutral{ background: color-mix(in srgb, var(--muted) 35%, transparent 65%); }

    .meals{ display:grid; gap:8px; }
    .mealRow{
      display:grid;
      grid-template-columns: 110px 1fr auto auto;
      gap:8px;
      align-items:center;
      padding:10px;
      border:1px solid var(--border);
      border-radius:12px;
      background: color-mix(in srgb, var(--card) 90%, #000 10%);
      position:relative;
    }
    .mealRow.dragOver{ outline:2px dashed color-mix(in srgb, var(--good2) 55%, transparent 45%); outline-offset:2px; }
    .mealRow[draggable="true"]{ cursor: grab; }
    .mealRow:active{ cursor: grabbing; }

    @media (max-width:640px){
      .mealRow{ grid-template-columns: 98px 1fr auto; grid-auto-rows:auto; }
      .mealRow .mealMacros{ grid-column: 2 / 3; justify-self:start; }
      .mealRow .mealBtn{ grid-column: 3 / 4; justify-self:end; }
    }

    .dishBlock{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .dishName{ font-size:14px; font-weight:800; line-height:1.2; }
    .dishLoc{ font-size:12px; font-style:italic; color:var(--muted); line-height:1.2; }
    .dishEmpty{ color: color-mix(in srgb, var(--muted) 85%, transparent 15%); font-weight:600; }

    .list{
      display:flex; flex-direction:column; gap:8px;
      overflow:auto;
      padding-right:4px;
      border-radius:12px;
    }
    @media (min-width: 921px){
      .list{ max-height: calc(100vh - 210px); }
    }
    @media (max-width:920px){
      .list{ max-height: 320px; }
    }

    .dish{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:start;
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 96%, #000 4%);
      user-select:none;
    }
    .dish[draggable="true"]{ cursor: grab; }
    .dish small{ color:var(--muted); font-size:12px; margin-left:6px; }

    .dish.selected{
      border-color: color-mix(in srgb, var(--accent1) 55%, var(--border) 45%);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent2) 25%, transparent 75%);
      background: color-mix(in srgb, var(--card) 88%, var(--accent2) 12%);
    }

    .dishActions{
      display:flex;
      gap:6px;
      align-items:center;
      justify-content:flex-end;
      padding-top:2px;
    }

    .miniIcon{
      width:30px; height:30px;
      display:inline-flex; align-items:center; justify-content:center;
      padding:0;
      border-radius:10px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 92%, #000 8%);
      cursor:pointer;
      line-height:1;
      font-size:14px;
    }
    .miniIcon svg{ width:16px; height:16px; stroke: currentColor; }
    .miniIcon.danger{
      border-color: color-mix(in srgb, var(--bad2) 35%, var(--border) 65%);
      color: color-mix(in srgb, var(--bad2) 70%, var(--text) 30%);
    }

    .ingPanel{
      margin-top:6px;
      border-left: 2px solid color-mix(in srgb, var(--accent2) 35%, var(--border) 65%);
      padding-left:10px;
      overflow:hidden;
      max-height: 0px;
      opacity: 0;
      transition: max-height .22s ease, opacity .18s ease;
      will-change: max-height, opacity;
    }
    .ingPanel.open{ opacity: 1; }
    .ingPanel em{
      font-style: italic;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
    }

    .assignBar{
      display:none;
      margin-top:10px;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 94%, #000 6%);
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .assignBar strong{ font-size:13px; }
    @media (max-width:920px){
      .assignBar{ display:flex; }
    }

    .checkRow{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .checkRow label{ display:flex; align-items:center; gap:6px; font-size:12px; color:var(--muted); }
    .checkRow input{ width:16px; height:16px; }

    .targetsGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    @media (max-width:520px){ .targetsGrid{ grid-template-columns:1fr; } }
    .targetsGrid label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .targetsGrid .field{ display:flex; flex-direction:column; }

    details > summary{
      cursor:pointer;
      user-select:none;
      color:var(--muted);
      font-size:12px;
    }

    .hintBox{
      margin-top:10px;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 94%, #000 6%);
      color:var(--muted);
      font-size:12px;
    }

    .weatherPill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 92%, #000 8%);
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
    }
    .weatherIcon{ font-size:14px; }
    .weatherTemp{ font-size:12px; color:var(--muted); }

    .mobilePantryBar{
      display:none;
      position: sticky;
      top: 76px;
      z-index:40;
      background: transparent;
    }
    @media (max-width:920px){
      .mobilePantryBar{ display:block; }
    }
    .mobilePantryBar .card{ padding:10px; }

    @media (max-width:920px){
      .pantryCollapsed aside.card{ display:none; }
      .pantryCollapsed .grid{ grid-template-columns: 1fr; }
    }

    .dayMenu{
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      margin-top:0;
    }
    .kebabBtn{
      width:32px;
      height:28px;
      padding:0;
      border-radius:10px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 92%, #000 8%);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color: var(--muted);
    }
    .kebabBtn:hover{
      background: color-mix(in srgb, var(--card) 86%, var(--accent2) 14%);
      color: color-mix(in srgb, var(--text) 75%, var(--muted) 25%);
    }
    .kebabDots{
      font-size:18px;
      line-height:1;
      transform: translateY(-1px);
    }
    .menuPanel{
      position:absolute;
      top:34px;
      right:0;
      min-width:200px;
      border-radius:12px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 96%, #000 4%);
      box-shadow: var(--shadow);
      padding:6px;
      z-index:25;
      display:none;
    }
    .menuPanel.open{ display:block; }
    .menuItem{
      width:100%;
      text-align:left;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid transparent;
      background: transparent;
      cursor:pointer;
      color: var(--text);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .menuItem:hover{
      background: color-mix(in srgb, var(--card) 86%, var(--accent2) 14%);
      border-color: color-mix(in srgb, var(--accent1) 30%, transparent 70%);
    }
    .menuItem.danger{
      color: color-mix(in srgb, var(--bad2) 75%, var(--text) 25%);
    }
    .menuItem.disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .menuItem.disabled:hover{
      background: transparent;
      border-color: transparent;
    }
    .menuItem .menuIcon{
      width:18px;
      text-align:center;
    }
    .menuDivider{
      height:1px;
      background: var(--border);
      margin:6px 4px;
      border-radius:999px;
    }

    dialog{
      border:none;
      border-radius:12px;
      padding:0;
      width:min(520px, 96vw);
      background:var(--card);
      color:var(--text);
      box-shadow: var(--shadow);
    }
    dialog::backdrop{ background:rgba(0,0,0,.45); }
    .dlg{ padding:14px; }
    .dlgHeader{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .dlgHeader h3{ margin:0; font-size:14px; }
    .dlgFooter{ display:flex; justify-content:flex-end; gap:10px; margin-top:12px; }
    .toastWarn { border-color: color-mix(in srgb, var(--warn2) 40%, var(--border) 60%) !important; }

    .fileRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .fileRow input[type="file"]{
      padding:6px 8px;
      border-radius:10px;
      max-width:100%;
    }
    .inlineNote{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
  </style>
</head>

<body>
  <header>
    <div class="row" style="gap:12px;">
      <div>
        <h1>Meal Planner ‚Äî Macros</h1>
      </div>

      <div class="headerRight">
        <button id="weatherBtn" class="iconBtn" type="button" title="Weather settings" aria-label="Weather settings">‚òÅÔ∏è</button>

        <button id="themeToggle" class="smallBtn toggleBtn" type="button" aria-label="Toggle light/dark">
          <span class="micro" id="themeLabel">Light</span>
          <span class="toggleDot" aria-hidden="true"></span>
        </button>
      </div>
    </div>
  </header>

  <main id="mainRoot">
    <div class="mobilePantryBar">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div class="micro" id="mobilePantryStatus"></div>
          <button id="togglePantry" class="smallBtn" type="button"></button>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Kitchen LEFT -->
      <aside class="card" id="pantryCard">
        <h2 id="kitchenTitle"></h2>

        <div class="row" style="margin-bottom:10px;">
          <input id="search" placeholder="Search dishes‚Ä¶" style="flex:1;" />
          <button id="clearSearch" class="smallBtn" type="button">‚úï</button>
        </div>

        <div class="checkRow" style="margin: 6px 0 10px;">
          <span class="muted">Filter:</span>
          <label><input type="checkbox" id="filterBreakfast" checked> Breakfast</label>
          <label><input type="checkbox" id="filterLunch" checked> Lunch</label>
          <label><input type="checkbox" id="filterDinner" checked> Dinner</label>
        </div>

        <div class="assignBar" id="assignBar">
          <div>
            <div class="micro">Selected dish</div>
            <strong id="selectedDishLabel">None</strong>
          </div>
          <div class="row" style="gap:8px;">
            <button id="clearSelected" class="smallBtn" type="button">Clear</button>
          </div>
        </div>

        <div class="list" id="dishList"></div>

        <div style="display:flex; justify-content:space-between; margin-top:10px;">
          <span class="muted" id="count"></span>
          <button id="reset" class="danger smallBtn" type="button">Reset</button>
        </div>

        <hr style="border:none;border-top:1px solid var(--border); margin:14px 0;" />

        <details id="targetsDetails">
          <summary>Daily targets (tap to expand)</summary>

          <div class="targetsGrid">
            <div class="field">
              <label for="tCal">Calories (kcal)</label>
              <input id="tCal" type="number" min="0" step="10" placeholder="e.g. 2200" />
            </div>
            <div class="field">
              <label for="tProtein">Protein (g)</label>
              <input id="tProtein" type="number" min="0" step="1" placeholder="e.g. 160" />
            </div>
            <div class="field">
              <label for="tCarbs">Carbs (g)</label>
              <input id="tCarbs" type="number" min="0" step="1" placeholder="e.g. 220" />
            </div>
            <div class="field">
              <label for="tFat">Fat (g)</label>
              <input id="tFat" type="number" min="0" step="1" placeholder="e.g. 70" />
            </div>
          </div>

          <div class="targetsGrid" style="margin-top:12px;">
            <div class="field">
              <label for="tolCalUnder">Calories under tolerance (%)</label>
              <input id="tolCalUnder" type="number" min="0" max="100" step="1" placeholder="50" />
              <div class="micro">Allowed as low as target minus this %.</div>
            </div>
            <div class="field">
              <label for="tolCalOver">Calories over tolerance (%)</label>
              <input id="tolCalOver" type="number" min="0" max="100" step="1" placeholder="5" />
              <div class="micro">Allowed up to target plus this %.</div>
            </div>
            <div class="field">
              <label for="tolCarbUnder">Carbs under tolerance (%)</label>
              <input id="tolCarbUnder" type="number" min="0" max="100" step="1" placeholder="50" />
              <div class="micro">Allowed as low as target minus this %.</div>
            </div>
            <div class="field">
              <label for="tolCarbOver">Carbs over tolerance (%)</label>
              <input id="tolCarbOver" type="number" min="0" max="100" step="1" placeholder="5" />
              <div class="micro">Allowed up to target plus this %.</div>
            </div>
          </div>

          <div class="row" style="justify-content:space-between; margin-top:10px;">
            <div class="muted">Smart fill + Shuffle use tolerances for Calories &amp; Carbs.</div>
            <button id="saveTargets" class="smallBtn" type="button">Save targets</button>
          </div>
        </details>

        <hr style="border:none;border-top:1px solid var(--border); margin:14px 0;" />

        <details id="dishAdminDetails">
          <summary>Add / Import dishes</summary>
          <div style="margin-top:12px; display:grid; gap:10px;">
            <input id="dishName" placeholder="Dish name" />

            <div class="row" style="flex-wrap:wrap;">
              <input id="dishCal" placeholder="Calories (kcal)" type="number" min="0" />
              <input id="dishProtein" placeholder="Protein (g)" type="number" min="0" />
              <input id="dishCarbs" placeholder="Carbs (g)" type="number" min="0" />
              <input id="dishFat" placeholder="Fat (g)" type="number" min="0" />
            </div>

            <div class="row" style="flex-wrap:wrap;">
              <input id="dishBook" placeholder="Recipe book (optional)" style="flex:1;" />
              <input id="dishPage" placeholder="Page" type="number" style="width:96px;" min="1" />
            </div>

            <div>
              <label class="muted" for="dishIngredients" style="display:block;margin-bottom:6px;">Ingredients (one per line)</label>
              <textarea id="dishIngredients" placeholder="e.g.&#10;chicken breast&#10;rice&#10;broccoli" style="min-height:92px;"></textarea>
              <div class="inlineNote">Tip: for CSV import/export, ingredients use <b>|</b> between items (but file import supports multiline too).</div>
            </div>

            <div class="checkRow">
              <span class="muted">Categories:</span>
              <label><input type="checkbox" id="catBreakfast"> Breakfast</label>
              <label><input type="checkbox" id="catLunch"> Lunch</label>
              <label><input type="checkbox" id="catDinner"> Dinner</label>
              <button class="primary" id="saveDish" style="margin-left:auto;" type="button">Save</button>
            </div>

            <div class="muted">
              CSV columns:
              <b>name, cal, protein, carbs, fat, book, page, breakfast, lunch, dinner, ingredients</b>
            </div>

            <div class="fileRow">
              <input id="csvFile" type="file" accept=".csv,text/csv" />
              <button id="importCsvFile" class="smallBtn" type="button">Import CSV file</button>
              <span class="muted">or paste below:</span>
            </div>

            <textarea id="bulk" placeholder='Example: Pasta bake,650,25,80,18,Everyday Meals,45,0,1,1,"chicken|pasta|tomato sauce"' style="width:100%; min-height:96px;"></textarea>
            <div class="row" style="justify-content:space-between; flex-wrap:wrap;">
              <span class="muted">Format: name, cal, protein, carbs, fat, book, page, b, l, d, ingredients</span>
              <button id="importBulk" class="smallBtn" type="button">Import</button>
            </div>

            <hr style="border:none;border-top:1px solid var(--border); margin:6px 0;" />

            <div class="fileRow">
              <button id="exportJson" class="smallBtn" type="button">Export JSON</button>
              <input id="jsonFile" type="file" accept=".json,application/json" />
              <button id="importJsonFile" class="smallBtn" type="button">Import JSON</button>
            </div>
            <div class="inlineNote">
              JSON export includes: dishes (with ingredients), targets, week plans, and weather settings. Import lets you <b>Replace</b> or <b>Merge</b>.
            </div>
          </div>
        </details>
      </aside>

      <!-- Week RIGHT -->
      <section class="card">
        <h2>Week plan</h2>

        <div class="row" style="justify-content:space-between; margin-bottom:10px; flex-wrap:wrap;">
          <div class="row">
            <button class="smallBtn" id="prevWeek" type="button">‚Üê</button>
            <button class="smallBtn" id="nextWeek" type="button">‚Üí</button>
            <div class="muted" id="weekRange" style="margin-left:10px;"></div>
          </div>

          <div class="row" style="flex-wrap:wrap;">
            <button id="fillEmpty" class="smallBtn" type="button">Fill empty meals (smart)</button>
            <button id="shuffleWeek" class="smallBtn" type="button">Shuffle week</button>
            <button class="primary" id="copyPlan" type="button">Copy plan</button>
            <button id="exportPDF" class="smallBtn" type="button" title="Print / Save as PDF">Export PDF</button>
            <button id="exportCSV" class="smallBtn" type="button">Export CSV</button>
            <button id="clearWeek" class="smallBtn danger" type="button" title="Clear all days in this week">Clear week</button>
          </div>
        </div>

        <div class="week" id="week"></div>

        <div class="hintBox">
          Smart fill + Shuffle week are <b>strict</b>:
          no repeats (day/week/previous weeks) and must fit within the <b>Calories &amp; Carbs</b> tolerance window.
          If there aren‚Äôt enough eligible dishes, some slots will remain empty.
        </div>
      </section>
    </div>
  </main>

  <!-- Weather Settings Dialog -->
  <dialog id="weatherDialog">
    <div class="dlg">
      <div class="dlgHeader">
        <h3>Weather settings</h3>
        <button class="smallBtn" id="closeWeather" type="button">Close</button>
      </div>

      <div style="display:grid; gap:10px; margin-top:10px;">
        <label class="checkRow" style="gap:10px;">
          <input id="showWeather" type="checkbox" />
          <span class="muted">Show weather on days</span>
        </label>

        <div class="row" style="flex-wrap:wrap; justify-content:space-between;">
          <button id="useMyLocation" class="smallBtn" type="button">Use my location</button>
          <span class="muted" id="locationStatus">No location set.</span>
        </div>

        <div class="row">
          <input id="locationQuery" placeholder="Search a place (e.g. London)" style="flex:1;" />
          <button id="findLocation" class="smallBtn" type="button">Find</button>
        </div>

        <div class="muted">Uses Open-Meteo (no API key). Location can be GPS or city search.</div>
      </div>

      <div class="dlgFooter">
        <button class="smallBtn danger" id="clearLocation" type="button">Clear location</button>
        <button class="primary" id="saveWeather" type="button">Save</button>
      </div>
    </div>
  </dialog>

<script>
(() => {
  const DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
  const MEALS = ["Breakfast","Lunch","Dinner"];
  const KEY = "mealPlanner.macro.v21"; // bumped version for PDF export
  const THEME_KEY = "mealPlanner.theme";
  const KITCHEN_LABEL = "Kitchen";

  // STRICT repeat rules configuration:
  const STRICT_NO_REPEATS = true;
  const NO_REPEAT_WEEKS_BACK = 4;

  const ICON_LIST = `
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M8 6h13M8 12h13M8 18h13" stroke-width="2" stroke-linecap="round"/>
      <path d="M4 6h.01M4 12h.01M4 18h.01" stroke-width="4" stroke-linecap="round"/>
    </svg>
  `;
  const ICON_CLOSE = `
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M6 6l12 12M18 6L6 18" stroke-width="2" stroke-linecap="round"/>
    </svg>
  `;

  function defaultState() {
    return {
      targets: { cal: 2200, protein: 160, carbs: 220, fat: 70 },
      tolerances: { calUnderPct: 50, calOverPct: 5, carbsUnderPct: 50, carbsOverPct: 5 },
      dishes: [
        {
          id: crypto.randomUUID(),
          name: "Pasta bake",
          cal: 650, protein: 25, carbs: 80, fat: 18,
          book: "Everyday Meals", page: 45,
          ingredients: ["chicken", "pasta", "tomato sauce"],
          categories: { Breakfast:false, Lunch:true, Dinner:true }
        },
        {
          id: crypto.randomUUID(),
          name: "Overnight oats",
          cal: 420, protein: 18, carbs: 55, fat: 12,
          book: "Breakfast Club", page: 12,
          ingredients: ["oats", "milk", "yogurt", "berries"],
          categories: { Breakfast:true, Lunch:false, Dinner:false }
        },
        {
          id: crypto.randomUUID(),
          name: "Chicken & rice",
          cal: 520, protein: 40, carbs: 55, fat: 10,
          book: "", page: null,
          ingredients: ["chicken", "rice", "broccoli"],
          categories: { Breakfast:false, Lunch:true, Dinner:true }
        }
      ],
      planByWeekStart: {},
      ui: { selectedDishId: null, dayClipboard: null, expandedIngredients: {} },
      weather: { enabled: false, locationName: "", lat: null, lon: null, tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "auto", cacheByWeek: {} },
      uiPrefs: { pantryCollapsedMobile: false }
    };
  }

  function loadState() {
    const tryKeys = [KEY, "mealPlanner.macro.v20", "mealPlanner.macro.v19", "mealPlanner.macro.v18", "mealPlanner.macro.v17", "mealPlanner.macro.v16", "mealPlanner.macro.v15"];
    for (const k of tryKeys) {
      const raw = localStorage.getItem(k);
      if (!raw) continue;
      try {
        const parsed = JSON.parse(raw);
        if (!parsed.dishes || !parsed.planByWeekStart) continue;

        const def = defaultState();
        parsed.targets = { ...def.targets, ...(parsed.targets || {}) };
        parsed.tolerances = { ...def.tolerances, ...(parsed.tolerances || {}) };
        parsed.ui = { ...def.ui, ...(parsed.ui || {}) };
        parsed.ui.expandedIngredients = parsed.ui.expandedIngredients && typeof parsed.ui.expandedIngredients === "object"
          ? parsed.ui.expandedIngredients : {};
        parsed.weather = { ...def.weather, ...(parsed.weather || {}) };
        parsed.uiPrefs = { ...def.uiPrefs, ...(parsed.uiPrefs || {}) };

        parsed.dishes = parsed.dishes.map(d => ({
          book: "",
          page: null,
          ingredients: [],
          categories: { Breakfast:true, Lunch:true, Dinner:true },
          ...d,
          ingredients: Array.isArray(d.ingredients)
            ? d.ingredients.map(x => String(x).trim()).filter(Boolean)
            : (String(d.ingredients || "").split("|").map(x=>x.trim()).filter(Boolean)),
          categories: { Breakfast:true, Lunch:true, Dinner:true, ...(d.categories || {}) }
        }));

        for (const wk of Object.keys(parsed.planByWeekStart)) {
          for (const day of DAYS) {
            if (!parsed.planByWeekStart[wk][day]) parsed.planByWeekStart[wk][day] = {};
            if (parsed.planByWeekStart[wk][day]._locked == null) parsed.planByWeekStart[wk][day]._locked = false;
            for (const meal of MEALS) {
              if (!parsed.planByWeekStart[wk][day][meal]) parsed.planByWeekStart[wk][day][meal] = { dishId: null, servings: 1 };
            }
          }
        }

        localStorage.setItem(KEY, JSON.stringify(parsed));
        return parsed;
      } catch {}
    }
    const fresh = defaultState();
    localStorage.setItem(KEY, JSON.stringify(fresh));
    return fresh;
  }

  let state = loadState();
  function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  document.addEventListener("click", () => {
    document.querySelectorAll(".menuPanel.open").forEach(m => m.classList.remove("open"));
  });

  // ---------- Theme ----------
  function getSystemTheme(){
    return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  }
  function getTheme(){
    return localStorage.getItem(THEME_KEY) || getSystemTheme();
  }
  function setTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem(THEME_KEY, theme);
    document.getElementById("themeLabel").textContent = theme === "dark" ? "Dark" : "Light";
  }
  setTheme(getTheme());
  document.getElementById("themeToggle").addEventListener("click", () => {
    const current = getTheme();
    setTheme(current === "dark" ? "light" : "dark");
  });

  // ---------- Dates ----------
  function formatDate(dateObj){
    try{
      return new Intl.DateTimeFormat(undefined, { day:"2-digit", month:"2-digit", year:"numeric" }).format(dateObj);
    } catch {
      const d = String(dateObj.getDate()).padStart(2,"0");
      const m = String(dateObj.getMonth()+1).padStart(2,"0");
      const y = dateObj.getFullYear();
      return `${d}/${m}/${y}`;
    }
  }
  function startOfWeek(date) {
    const d = new Date(date);
    d.setHours(0,0,0,0);
    const day = (d.getDay() + 6) % 7; // Monday=0
    d.setDate(d.getDate() - day);
    return d;
  }
  function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
  function toISO(d){ const x = new Date(d); x.setHours(0,0,0,0); return x.toISOString().slice(0,10); }
  function fmtRange(ws){
    const a = new Date(ws), b = addDays(a,6);
    const opts = { day:"2-digit", month:"short" };
    return `${a.toLocaleDateString(undefined,opts)} ‚Äì ${b.toLocaleDateString(undefined,opts)} ${a.getFullYear()}`;
  }

  let weekStart = startOfWeek(new Date());

  function emptyMeal(){ return { dishId: null, servings: 1 }; }
  function emptyDay(){ const obj = { _locked:false }; ["Breakfast","Lunch","Dinner"].forEach(m => obj[m] = emptyMeal()); return obj; }

  function ensureWeekPlan(ws=weekStart){
    const key = toISO(ws);
    if (!state.planByWeekStart[key]) {
      state.planByWeekStart[key] = Object.fromEntries(["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"].map(d => [d, emptyDay()]));
      saveState();
    } else {
      ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"].forEach(day => {
        if (!state.planByWeekStart[key][day]) state.planByWeekStart[key][day] = emptyDay();
        if (state.planByWeekStart[key][day]._locked == null) state.planByWeekStart[key][day]._locked = false;
        ["Breakfast","Lunch","Dinner"].forEach(meal => {
          if (!state.planByWeekStart[key][day][meal]) state.planByWeekStart[key][day][meal] = emptyMeal();
        });
      });
    }
    return state.planByWeekStart[key];
  }

  // ---------- DOM ----------
  const mainRoot = document.getElementById("mainRoot");
  const elWeek = document.getElementById("week");
  const elWeekRange = document.getElementById("weekRange");
  const elDishList = document.getElementById("dishList");
  const elCount = document.getElementById("count");
  const elSearch = document.getElementById("search");

  const filterBreakfast = document.getElementById("filterBreakfast");
  const filterLunch = document.getElementById("filterLunch");
  const filterDinner = document.getElementById("filterDinner");

  const selectedDishLabel = document.getElementById("selectedDishLabel");
  const clearSelected = document.getElementById("clearSelected");

  const tCal = document.getElementById("tCal");
  const tProtein = document.getElementById("tProtein");
  const tCarbs = document.getElementById("tCarbs");
  const tFat = document.getElementById("tFat");

  const tolCalUnder = document.getElementById("tolCalUnder");
  const tolCalOver = document.getElementById("tolCalOver");
  const tolCarbUnder = document.getElementById("tolCarbUnder");
  const tolCarbOver = document.getElementById("tolCarbOver");

  // Add/import section
  const dishAdminDetails = document.getElementById("dishAdminDetails");
  const elDishName = document.getElementById("dishName");
  const elDishCal = document.getElementById("dishCal");
  const elDishProtein = document.getElementById("dishProtein");
  const elDishCarbs = document.getElementById("dishCarbs");
  const elDishFat = document.getElementById("dishFat");
  const elDishBook = document.getElementById("dishBook");
  const elDishPage = document.getElementById("dishPage");
  const elDishIngredients = document.getElementById("dishIngredients");
  const catBreakfast = document.getElementById("catBreakfast");
  const catLunch = document.getElementById("catLunch");
  const catDinner = document.getElementById("catDinner");
  const elBulk = document.getElementById("bulk");

  // File import/export
  const csvFile = document.getElementById("csvFile");
  const importCsvFileBtn = document.getElementById("importCsvFile");
  const exportJsonBtn = document.getElementById("exportJson");
  const jsonFile = document.getElementById("jsonFile");
  const importJsonFileBtn = document.getElementById("importJsonFile");

  // Weather dialog
  const weatherBtn = document.getElementById("weatherBtn");
  const weatherDialog = document.getElementById("weatherDialog");
  const closeWeather = document.getElementById("closeWeather");
  const showWeather = document.getElementById("showWeather");
  const useMyLocation = document.getElementById("useMyLocation");
  const locationQuery = document.getElementById("locationQuery");
  const findLocation = document.getElementById("findLocation");
  const locationStatus = document.getElementById("locationStatus");
  const saveWeatherBtn = document.getElementById("saveWeather");
  const clearLocationBtn = document.getElementById("clearLocation");

  // Mobile kitchen toggle
  const togglePantryBtn = document.getElementById("togglePantry");
  const mobilePantryStatus = document.getElementById("mobilePantryStatus");

  const kitchenTitle = document.getElementById("kitchenTitle");
  if (kitchenTitle) kitchenTitle.textContent = KITCHEN_LABEL;

  function toast(msg, kind="info"){
    let el = document.getElementById("__toast");
    if (!el) {
      el = document.createElement("div");
      el.id="__toast";
      el.style.cssText = `
        position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
        background: color-mix(in srgb, var(--card) 96%, #000 4%);
        padding:10px 14px;border-radius:999px;border:1px solid var(--border);
        box-shadow: var(--shadow);font-size:13px;color:var(--text);z-index:9999;
        opacity:0;transition:opacity .15s;`;
      document.body.appendChild(el);
    }
    el.classList.remove("toastWarn");
    if (kind === "warn") el.classList.add("toastWarn");
    el.textContent = msg;
    el.style.opacity = "1";
    setTimeout(()=> el.style.opacity="0", 1900);
  }

  function normalizeName(s){
    const raw = String(s ?? "");
    const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
    return lines.join(" ").replace(/\s{2,}/g, " ").trim();
  }

  function getDish(id){ return state.dishes.find(d => d.id === id) || null; }

  function dishLocation(d){
    if (!d) return "";
    const book = (d.book || "").trim();
    const page = d.page != null && d.page !== "" ? String(d.page) : "";
    if (!book && !page) return "";
    if (book && page) return `${book} ‚Ä¢ p.${page}`;
    if (book) return book;
    return `p.${page}`;
  }

  function ingredientsToText(ingredients){
    const arr = Array.isArray(ingredients) ? ingredients : [];
    return arr.map(x => String(x).trim()).filter(Boolean).join(", ");
  }

  function parseIngredientsFromText(text){
    const raw = String(text || "");
    const lines = raw.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    if (lines.length > 1) return lines;
    const one = raw.trim();
    if (!one) return [];
    if (one.includes("|")) return one.split("|").map(x=>x.trim()).filter(Boolean);
    if (one.includes(",")) return one.split(",").map(x=>x.trim()).filter(Boolean);
    return [one];
  }

  // ---------- Filters ----------
  function getSelectedCategories(){
    const selected = new Set();
    if (filterBreakfast.checked) selected.add("Breakfast");
    if (filterLunch.checked) selected.add("Lunch");
    if (filterDinner.checked) selected.add("Dinner");
    return selected;
  }
  function filteredDishes(q){
    const s=(q||"").trim().toLowerCase();
    const selected = getSelectedCategories();
    const useFilter = selected.size > 0 && selected.size < 3;

    const arr=[...state.dishes].sort((a,b)=>a.name.localeCompare(b.name));
    return arr.filter(d => {
      const ing = ingredientsToText(d.ingredients).toLowerCase();
      const textOk = !s ||
        d.name.toLowerCase().includes(s) ||
        (d.book||"").toLowerCase().includes(s) ||
        ing.includes(s);
      if (!textOk) return false;

      if (!useFilter || selected.size === 0) return true;
      const cats = d.categories || {};
      for (const c of selected){
        if (cats[c]) return true;
      }
      return false;
    });
  }

  // ---------- Totals ----------
  function dayTotals(dayObj){
    let cal=0, protein=0, carbs=0, fat=0;
    ["Breakfast","Lunch","Dinner"].forEach(meal => {
      const entry = dayObj[meal];
      if (!entry?.dishId) return;
      const d = getDish(entry.dishId);
      if (!d) return;
      cal += (Number(d.cal)||0);
      protein += (Number(d.protein)||0);
      carbs += (Number(d.carbs)||0);
      fat += (Number(d.fat)||0);
    });
    return { cal, protein, carbs, fat };
  }

  function macroClass(actual, target){
    if (!target || target <= 0) return "neutral";
    if (actual > target) return "red";
    if (actual === target) return "green";
    return "amber";
  }
  function macroFillPct(actual, target){
    if (!target || target <= 0) return 0;
    return Math.max(0, Math.min(130, (actual / target) * 100));
  }
  function macroProgressHTML(tot){
    const tar = state.targets || {};
    const rows = [
      { label:"kcal", a:tot.cal, t:tar.cal },
      { label:"P",    a:tot.protein, t:tar.protein },
      { label:"C",    a:tot.carbs, t:tar.carbs },
      { label:"F",    a:tot.fat, t:tar.fat },
    ];
    return `
      <div class="progressWrap">
        ${rows.map(r => {
          const cls = macroClass(r.a, r.t);
          const pct = macroFillPct(r.a, r.t);
          const tip = `${r.label}: ${Math.round(r.a)}/${r.t ? Math.round(r.t) : "‚Äì"}`;
          return `
            <div class="progItem" title="${tip}">
              <div class="progLabel">${r.label}</div>
              <div class="bar"><span class="fill ${cls}" style="width:${pct.toFixed(1)}%;"></span></div>
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  // ---------- Tolerance bounds ----------
  function clampPct(x, def){
    const n = Number(x);
    if (!Number.isFinite(n)) return def;
    return Math.max(0, Math.min(100, n));
  }
  function getTol(){
    const def = defaultState().tolerances;
    const t = state.tolerances || {};
    return {
      calUnderPct: clampPct(t.calUnderPct, def.calUnderPct),
      calOverPct: clampPct(t.calOverPct, def.calOverPct),
      carbsUnderPct: clampPct(t.carbsUnderPct, def.carbsUnderPct),
      carbsOverPct: clampPct(t.carbsOverPct, def.carbsOverPct),
    };
  }
  function getBounds(){
    const tar = state.targets || {};
    const tol = getTol();
    const calT = Number(tar.cal)||0;
    const carbT = Number(tar.carbs)||0;

    const calMin = calT > 0 ? calT * (1 - tol.calUnderPct/100) : -Infinity;
    const calMax = calT > 0 ? calT * (1 + tol.calOverPct/100) : Infinity;

    const carbMin = carbT > 0 ? carbT * (1 - tol.carbsUnderPct/100) : -Infinity;
    const carbMax = carbT > 0 ? carbT * (1 + tol.carbsOverPct/100) : Infinity;

    return { calMin, calMax, carbMin, carbMax };
  }

  // ---------- Category validation ----------
  function isDishAllowedForMeal(dish, meal){
    if (!dish) return false;
    const cats = dish.categories || {};
    if (cats[meal] === false) return false;
    return true;
  }
  function confirmCategoryMismatchIfNeeded(dish, meal){
    if (!dish) return false;
    if (isDishAllowedForMeal(dish, meal)) return true;
    return confirm(`‚Äú${dish.name}‚Äù isn‚Äôt tagged for ${meal}.\n\nAssign anyway?`);
  }

  // ---------- Tap-to-assign ----------
  function setSelectedDish(id){
    state.ui.selectedDishId = id;
    saveState();
    updateSelectedDishUI();
    renderDishList();
  }
  function clearSelectedDish(){
    state.ui.selectedDishId = null;
    saveState();
    updateSelectedDishUI();
    renderDishList();
  }
  function updateSelectedDishUI(){
    const d = state.ui.selectedDishId ? getDish(state.ui.selectedDishId) : null;
    selectedDishLabel.textContent = d ? d.name : "None";
    clearSelected.disabled = !d;
  }
  function assignSelectedDishToSlot(day, meal){
    const id = state.ui.selectedDishId;
    if (!id) return;
    const dish = getDish(id);
    if (!dish) return;

    const plan = ensureWeekPlan();
    if (plan[day]._locked) return toast(`${day} is locked`, "warn");

    if (!confirmCategoryMismatchIfNeeded(dish, meal)) {
      toast("Assignment cancelled");
      return;
    }

    plan[day][meal] = { dishId: id, servings: 1 };
    saveState();
    renderWeek();
  }

  // ---------- Weather ----------
  function weatherEmoji(code){
    if (code === 0) return "‚òÄÔ∏è";
    if (code === 1) return "üå§Ô∏è";
    if (code === 2) return "‚õÖ";
    if (code === 3) return "‚òÅÔ∏è";
    if ([45,48].includes(code)) return "üå´Ô∏è";
    if ([51,53,55,56,57].includes(code)) return "üå¶Ô∏è";
    if ([61,63,65,66,67].includes(code)) return "üåßÔ∏è";
    if ([71,73,75,77].includes(code)) return "üå®Ô∏è";
    if ([80,81,82].includes(code)) return "üåßÔ∏è";
    if ([85,86].includes(code)) return "üå®Ô∏è";
    if ([95,96,99].includes(code)) return "‚õàÔ∏è";
    return "üå°Ô∏è";
  }
  function weatherKeyForCache(){
    const w = state.weather || {};
    return `${(w.lat ?? "")},${(w.lon ?? "")}`;
  }
  function setLocationStatus(){
    const w = state.weather || {};
    if (w.lat == null || w.lon == null) {
      locationStatus.textContent = "No location set.";
      return;
    }
    const name = w.locationName ? ` (${w.locationName})` : "";
    locationStatus.textContent = `Location: ${w.lat.toFixed(4)}, ${w.lon.toFixed(4)}${name}`;
  }
  async function fetchWeatherForWeek(){
    const w = state.weather;
    if (!w.enabled) return;
    if (w.lat == null || w.lon == null) return;

    const weekIso = toISO(weekStart);
    const cacheKey = `${weekIso}|${weatherKeyForCache()}`;
    if (w.cacheByWeek[cacheKey]) return;

    const start = new Date(weekStart);
    const end = addDays(start, 6);
    const startStr = toISO(start);
    const endStr = toISO(end);
    const tz = w.tz || "auto";

    const url =
      `https://api.open-meteo.com/v1/forecast` +
      `?latitude=${encodeURIComponent(w.lat)}` +
      `&longitude=${encodeURIComponent(w.lon)}` +
      `&daily=weathercode,temperature_2m_max,temperature_2m_min` +
      `&temperature_unit=celsius` +
      `&timezone=${encodeURIComponent(tz)}` +
      `&start_date=${encodeURIComponent(startStr)}` +
      `&end_date=${encodeURIComponent(endStr)}`;

    try{
      const res = await fetch(url);
      if (!res.ok) throw new Error("Weather fetch failed");
      const data = await res.json();

      const out = {};
      const times = data?.daily?.time || [];
      const codes = data?.daily?.weathercode || [];
      const tmax = data?.daily?.temperature_2m_max || [];
      const tmin = data?.daily?.temperature_2m_min || [];

      for (let i=0;i<times.length;i++){
        out[times[i]] = { code: codes[i], tmax: tmax[i], tmin: tmin[i] };
      }

      w.cacheByWeek[cacheKey] = { fetchedAt: Date.now(), byDateISO: out };
      saveState();
    } catch {
      toast("Couldn‚Äôt load weather (check internet).", "warn");
    }
  }
  function getWeatherForDate(dateObj){
    const w = state.weather;
    if (!w.enabled) return null;
    if (w.lat == null || w.lon == null) return null;

    const weekIso = toISO(weekStart);
    const cacheKey = `${weekIso}|${weatherKeyForCache()}`;
    const cached = w.cacheByWeek[cacheKey];
    if (!cached) return null;
    return cached.byDateISO?.[toISO(dateObj)] || null;
  }
  async function setLocationByGeolocation(){
    if (!navigator.geolocation) return toast("Geolocation not supported.", "warn");
    toast("Requesting location permission‚Ä¶");
    navigator.geolocation.getCurrentPosition(async (pos) => {
      state.weather.lat = pos.coords.latitude;
      state.weather.lon = pos.coords.longitude;
      state.weather.locationName = "";
      state.weather.cacheByWeek = {};
      saveState();
      setLocationStatus();
      await fetchWeatherForWeek();
      renderWeek();
    }, () => toast("Location permission denied/unavailable.", "warn"),
    { enableHighAccuracy:false, timeout:10000, maximumAge: 600000 });
  }
  async function setLocationBySearch(query){
    const q = (query || "").trim();
    if (!q) return toast("Enter a place name first", "warn");

    const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=en&format=json`;
    try{
      const res = await fetch(url);
      if (!res.ok) throw new Error("Geo search failed");
      const data = await res.json();
      const r = data?.results?.[0];
      if (!r) return toast("No results found", "warn");

      state.weather.lat = r.latitude;
      state.weather.lon = r.longitude;
      state.weather.locationName = [r.name, r.admin1, r.country].filter(Boolean).join(", ");
      state.weather.tz = r.timezone || state.weather.tz;
      state.weather.cacheByWeek = {};
      saveState();
      setLocationStatus();
      await fetchWeatherForWeek();
      renderWeek();
    } catch {
      toast("Couldn‚Äôt search location (check internet).", "warn");
    }
  }
  function clearWeatherLocation(){
    state.weather.lat = null;
    state.weather.lon = null;
    state.weather.locationName = "";
    state.weather.cacheByWeek = {};
    saveState();
    setLocationStatus();
    renderWeek();
  }

  // ---------- Dish CRUD ----------
  function clearDishForm(){
    elDishName.value = "";
    elDishCal.value = "";
    elDishProtein.value = "";
    elDishCarbs.value = "";
    elDishFat.value = "";
    elDishBook.value = "";
    elDishPage.value = "";
    elDishIngredients.value = "";
    catBreakfast.checked = true;
    catLunch.checked = true;
    catDinner.checked = true;
    elDishName.dataset.editing = "";
  }

  function saveDishFromForm(){
    const name = normalizeName(elDishName.value);
    if (!name) return toast("Name required", "warn");

    const cal = Number(elDishCal.value) || 0;
    const protein = Number(elDishProtein.value) || 0;
    const carbs = Number(elDishCarbs.value) || 0;
    const fat = Number(elDishFat.value) || 0;

    const book = (elDishBook.value || "").trim();
    const pageVal = elDishPage.value ? Number(elDishPage.value) : null;

    const ingredients = parseIngredientsFromText(elDishIngredients.value);

    const categories = {
      Breakfast: !!catBreakfast.checked,
      Lunch: !!catLunch.checked,
      Dinner: !!catDinner.checked
    };
    if (!categories.Breakfast && !categories.Lunch && !categories.Dinner) {
      categories.Breakfast = categories.Lunch = categories.Dinner = true;
    }

    const editingId = elDishName.dataset.editing;
    if (editingId) {
      const idx = state.dishes.findIndex(d => d.id === editingId);
      if (idx !== -1) {
        state.dishes[idx] = { ...state.dishes[idx], name, cal, protein, carbs, fat, book, page: pageVal, ingredients, categories };
        saveState();
        clearDishForm();
        renderDishList();
        renderWeek();
        return toast("Dish updated");
      }
    }

    if (state.dishes.some(d => d.name.toLowerCase() === name.toLowerCase())) {
      return toast("Dish already exists", "warn");
    }

    state.dishes.push({ id: crypto.randomUUID(), name, cal, protein, carbs, fat, book, page: pageVal, ingredients, categories });
    saveState();
    clearDishForm();
    renderDishList();
    toast("Dish saved");
  }

  function editDish(id){
    const d = getDish(id);
    if (!d) return;
    dishAdminDetails.open = true;
    elDishName.value = d.name;
    elDishCal.value = d.cal;
    elDishProtein.value = d.protein;
    elDishCarbs.value = d.carbs;
    elDishFat.value = d.fat ?? 0;
    elDishBook.value = d.book ?? "";
    elDishPage.value = d.page ?? "";
    elDishIngredients.value = (Array.isArray(d.ingredients) ? d.ingredients : []).join("\n");
    catBreakfast.checked = !!d.categories?.Breakfast;
    catLunch.checked = !!d.categories?.Lunch;
    catDinner.checked = !!d.categories?.Dinner;
    elDishName.dataset.editing = d.id;
    elDishName.focus();
  }

  function deleteDish(id){
    const d = getDish(id);
    if (!d) return;
    if (!confirm(`Delete ‚Äú${d.name}‚Äù? It will be removed from any plans too.`)) return;

    state.dishes = state.dishes.filter(x => x.id !== id);

    for (const wk of Object.keys(state.planByWeekStart)) {
      DAYS.forEach(day => {
        MEALS.forEach(meal => {
          const e = state.planByWeekStart[wk]?.[day]?.[meal];
          if (e?.dishId === id) state.planByWeekStart[wk][day][meal] = emptyMeal();
        });
      });
    }

    if (state.ui.selectedDishId === id) state.ui.selectedDishId = null;

    if (state.ui.expandedIngredients && state.ui.expandedIngredients[id] != null) {
      delete state.ui.expandedIngredients[id];
    }

    saveState();
    updateSelectedDishUI();
    renderDishList();
    renderWeek();
    toast("Dish deleted");
  }

  function parseBoolLike(v){
    const s = String(v ?? "").trim().toLowerCase();
    if (!s) return false;
    return ["1","true","yes","y","t"].includes(s);
  }

  // ---------- Robust CSV parsing ----------
  function detectDelimiterFromHeader(text){
    const firstLine = (text || "").split(/\r?\n/)[0] || "";
    const candidates = [",",";","\t"];
    let best = ",", bestCount = -1;
    for (const d of candidates){
      const rx = d === "\t" ? /\t/g : new RegExp("\\" + d, "g");
      const count = (firstLine.match(rx) || []).length;
      if (count > bestCount){ bestCount = count; best = d; }
    }
    return best;
  }

  function parseCSVText(text, delimiter){
    const rows = [];
    let row = [];
    let field = "";
    let inQuotes = false;

    text = (text || "").replace(/^\uFEFF/, "");

    for (let i = 0; i < text.length; i++){
      const ch = text[i];
      const next = text[i+1];

      if (ch === '"'){
        if (inQuotes && next === '"'){ field += '"'; i++; }
        else { inQuotes = !inQuotes; }
        continue;
      }

      if (!inQuotes && ch === delimiter){
        row.push(field);
        field = "";
        continue;
      }

      if (!inQuotes && (ch === "\n" || ch === "\r")){
        if (ch === "\r" && next === "\n") i++;
        row.push(field);
        field = "";
        if (!(row.length === 1 && row[0].trim() === "")) rows.push(row);
        row = [];
        continue;
      }

      field += ch;
    }

    row.push(field);
    if (!(row.length === 1 && row[0].trim() === "")) rows.push(row);
    return rows;
  }

  function parseCSVLine(line, delimiter){
    const out = [];
    let cur = "";
    let inQuotes = false;

    for (let i=0;i<line.length;i++){
      const ch = line[i];
      const next = line[i+1];
      if (ch === '"'){
        if (inQuotes && next === '"'){ cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }
      if (ch === delimiter && !inQuotes){
        out.push(cur.trim());
        cur = "";
        continue;
      }
      cur += ch;
    }
    out.push(cur.trim());
    return out;
  }

  function importRowsAsDishes(rows){
    let added = 0, skipped = 0;
    if (!rows || rows.length === 0) return toast("No usable rows found", "warn");

    const first = rows[0].map(x => String(x ?? "").trim());
    const lower = first.map(x => x.toLowerCase());

    const looksLikeHeader =
      lower.includes("name") &&
      (lower.includes("cal") || lower.includes("calories")) &&
      (lower.includes("protein") || lower.includes("protein_g"));

    let headerMap = null;
    if (looksLikeHeader){
      headerMap = {};
      lower.forEach((h, i) => headerMap[h] = i);
    }

    function get(parts, ...keys){
      if (!headerMap) return null;
      for (const k of keys){
        if (headerMap[k] != null) return parts[headerMap[k]];
      }
      return null;
    }

    const startIndex = headerMap ? 1 : 0;

    for (let r = startIndex; r < rows.length; r++){
      const parts = rows[r].map(v => String(v ?? "").trim());
      if (!parts.length) { skipped++; continue; }

      if (!headerMap && parts.length < 5) { skipped++; continue; }

      const nameRaw = headerMap ? (get(parts, "name") ?? "") : (parts[0] ?? "");
      const name = normalizeName(nameRaw);
      if (!name) { skipped++; continue; }

      const cal = Number(headerMap ? (get(parts,"cal","calories") ?? 0) : (parts[1] ?? 0)) || 0;
      const protein = Number(headerMap ? (get(parts,"protein","protein_g") ?? 0) : (parts[2] ?? 0)) || 0;
      const carbs = Number(headerMap ? (get(parts,"carbs","carbs_g","carbohydrates") ?? 0) : (parts[3] ?? 0)) || 0;
      const fat = Number(headerMap ? (get(parts,"fat","fat_g") ?? 0) : (parts[4] ?? 0)) || 0;

      const book = headerMap ? (get(parts,"book","recipe_book") ?? "") : (parts[5] ?? "");
      const pageRaw = headerMap ? (get(parts,"page") ?? "") : (parts[6] ?? "");
      const page = pageRaw === "" ? null : (Number(pageRaw) || null);

      let categories = { Breakfast:true, Lunch:true, Dinner:true };
      if (headerMap){
        const b = parseBoolLike(get(parts,"breakfast") ?? "");
        const l = parseBoolLike(get(parts,"lunch") ?? "");
        const d = parseBoolLike(get(parts,"dinner") ?? "");
        if (b || l || d) categories = { Breakfast:b, Lunch:l, Dinner:d };
      } else if (parts.length >= 10) {
        categories = {
          Breakfast: parseBoolLike(parts[7]),
          Lunch: parseBoolLike(parts[8]),
          Dinner: parseBoolLike(parts[9]),
        };
        if (!categories.Breakfast && !categories.Lunch && !categories.Dinner) {
          categories.Breakfast = categories.Lunch = categories.Dinner = true;
        }
      }

      const ingRaw = headerMap ? (get(parts,"ingredients") ?? "") : (parts[10] ?? "");
      const ingredients = parseIngredientsFromText(ingRaw);

      if (state.dishes.some(d => d.name.toLowerCase() === name.toLowerCase())) { skipped++; continue; }

      state.dishes.push({
        id: crypto.randomUUID(),
        name, cal, protein, carbs, fat,
        book: (book || "").trim(),
        page,
        ingredients,
        categories
      });
      added++;
    }

    saveState();
    renderDishList();
    renderWeek();
    toast(`Imported ${added}, skipped ${skipped}`);
  }

  async function importCsvFromFile(file){
    if (!file) return toast("Choose a CSV file first", "warn");
    const text = await file.text();
    const delimiter = detectDelimiterFromHeader(text);
    const rows = parseCSVText(text, delimiter);
    if (!rows.length) return toast("CSV was empty", "warn");
    importRowsAsDishes(rows);
  }

  function importLinesAsDishes(lines){
    const firstNonEmpty = (lines || []).find(l => (l || "").trim());
    if (!firstNonEmpty) return toast("No usable rows found", "warn");
    const delim = detectDelimiterFromHeader(firstNonEmpty);

    const rows = [];
    for (const line of lines){
      const raw = (line || "").trim();
      if (!raw) continue;
      rows.push(parseCSVLine(raw, delim));
    }
    importRowsAsDishes(rows);
  }

  function importBulkCSV(){
    const text = elBulk.value || "";
    const lines = text.split(/\r?\n/);
    importLinesAsDishes(lines);
    elBulk.value = "";
  }

  // ---------- JSON Export / Import ----------
  function exportJSON(){
    const payload = { version: 1, exportedAt: new Date().toISOString(), data: state };
    const json = JSON.stringify(payload, null, 2);
    const blob = new Blob([json], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `meal-planner-backup-${toISO(new Date())}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("Exported JSON");
  }

  function normalizeImportedState(incoming){
    const def = defaultState();
    const s = incoming && typeof incoming === "object" ? incoming : {};
    s.targets = { ...def.targets, ...(s.targets || {}) };
    s.tolerances = { ...def.tolerances, ...(s.tolerances || {}) };
    s.ui = { ...def.ui, ...(s.ui || {}) };
    s.ui.expandedIngredients = s.ui.expandedIngredients && typeof s.ui.expandedIngredients === "object"
      ? s.ui.expandedIngredients : {};
    s.weather = { ...def.weather, ...(s.weather || {}) };
    s.uiPrefs = { ...def.uiPrefs, ...(s.uiPrefs || {}) };
    s.planByWeekStart = s.planByWeekStart || {};
    s.dishes = Array.isArray(s.dishes) ? s.dishes : [];

    s.dishes = s.dishes.map(d => ({
      id: d.id || crypto.randomUUID(),
      name: normalizeName(d.name || ""),
      cal: Number(d.cal) || 0,
      protein: Number(d.protein) || 0,
      carbs: Number(d.carbs) || 0,
      fat: Number(d.fat) || 0,
      book: (d.book || "").trim(),
      page: (d.page === "" || d.page == null) ? null : Number(d.page),
      ingredients: Array.isArray(d.ingredients) ? d.ingredients.map(x => String(x).trim()).filter(Boolean) : parseIngredientsFromText(d.ingredients || ""),
      categories: { Breakfast:true, Lunch:true, Dinner:true, ...(d.categories || {}) }
    })).filter(d => d.name);

    for (const wk of Object.keys(s.planByWeekStart)) {
      for (const day of DAYS) {
        if (!s.planByWeekStart[wk][day]) s.planByWeekStart[wk][day] = {};
        if (s.planByWeekStart[wk][day]._locked == null) s.planByWeekStart[wk][day]._locked = false;
        for (const meal of MEALS) {
          if (!s.planByWeekStart[wk][day][meal]) s.planByWeekStart[wk][day][meal] = { dishId: null, servings: 1 };
        }
      }
    }
    return s;
  }

  function mergeState(current, imported){
    const merged = structuredClone(current);
    merged.targets = { ...merged.targets, ...(imported.targets || {}) };
    merged.tolerances = { ...merged.tolerances, ...(imported.tolerances || {}) };
    merged.weather = { ...merged.weather, ...(imported.weather || {}) };
    if (merged.weather) merged.weather.cacheByWeek = {};

    const byName = new Map();
    for (const d of merged.dishes) byName.set(d.name.toLowerCase(), d);
    for (const d of imported.dishes || []) byName.set(d.name.toLowerCase(), d);
    merged.dishes = Array.from(byName.values());

    merged.planByWeekStart = { ...(merged.planByWeekStart || {}), ...(imported.planByWeekStart || {}) };

    merged.uiPrefs = { ...(merged.uiPrefs || {}), ...(current.uiPrefs || {}) };
    merged.ui = { ...(merged.ui || {}), ...(current.ui || {}) };
    merged.ui.expandedIngredients = merged.ui.expandedIngredients && typeof merged.ui.expandedIngredients === "object"
      ? merged.ui.expandedIngredients : {};

    return merged;
  }

  async function importJSONFromFile(file){
    if (!file) return toast("Choose a JSON file first", "warn");
    let text = "";
    try { text = await file.text(); } catch { return toast("Couldn't read file", "warn"); }

    let parsed;
    try { parsed = JSON.parse(text); } catch { return toast("Invalid JSON", "warn"); }

    const incomingData = parsed && parsed.data ? parsed.data : parsed;
    const normalized = normalizeImportedState(incomingData);

    const replace = confirm("Import JSON:\n\nOK = REPLACE everything on this device\nCancel = MERGE into existing data");

    if (replace) {
      state = normalized;
      state.ui.selectedDishId = null;
      state.ui.dayClipboard = null;
      saveState();
      renderAll();
      toast("Imported (replaced)");
      return;
    }

    state = mergeState(state, normalized);
    state.ui.selectedDishId = null;
    state.ui.dayClipboard = null;
    saveState();
    renderAll();
    toast("Imported (merged)");
  }

  // ---------- Targets & tolerances ----------
  function saveTargets(){
    state.targets = {
      cal: Number(tCal.value) || 0,
      protein: Number(tProtein.value) || 0,
      carbs: Number(tCarbs.value) || 0,
      fat: Number(tFat.value) || 0
    };
    state.tolerances = {
      calUnderPct: clampPct(tolCalUnder.value, 50),
      calOverPct: clampPct(tolCalOver.value, 5),
      carbsUnderPct: clampPct(tolCarbUnder.value, 50),
      carbsOverPct: clampPct(tolCarbOver.value, 5),
    };
    saveState();
    renderWeek();
    toast("Targets saved");
  }

  // ---------- Smart fill helpers ----------
  function dishesForMeal(meal){
    return state.dishes.filter(d => isDishAllowedForMeal(d, meal) && !!d.categories?.[meal]);
  }

  function hasTargets(){
    const tar = state.targets || {};
    return (tar.cal||0) > 0 || (tar.protein||0) > 0 || (tar.carbs||0) > 0 || (tar.fat||0) > 0;
  }

  function scoreAgainstTargets(tot){
    const tar = state.targets || { cal:0, protein:0, carbs:0, fat:0 };
    if (!hasTargets()) return 0;
    function term(actual, target){
      if (!target || target <= 0) return 0;
      const diff = (actual - target) / target;
      return diff * diff;
    }
    return (
      1.0 * term(tot.cal, tar.cal) +
      1.4 * term(tot.protein, tar.protein) +
      1.1 * term(tot.carbs, tar.carbs) +
      1.1 * term(tot.fat, tar.fat)
    );
  }

  function dayTotalsIfAddDish(dayObj, dish){
    const t = dayTotals(dayObj);
    return {
      cal:t.cal+(+dish.cal||0),
      protein:t.protein+(+dish.protein||0),
      carbs:t.carbs+(+dish.carbs||0),
      fat:t.fat+(+dish.fat||0)
    };
  }

  function remainingEmptySlots(dayObj){
    let n = 0;
    for (const meal of MEALS){
      if (!dayObj[meal]?.dishId) n++;
    }
    return n;
  }

  function getUsedDishIdsForWeek(weekIso){
    const plan = state.planByWeekStart?.[weekIso];
    const used = new Set();
    if (!plan) return used;
    for (const day of DAYS){
      const dayObj = plan[day];
      if (!dayObj) continue;
      for (const meal of MEALS){
        const id = dayObj[meal]?.dishId;
        if (id) used.add(id);
      }
    }
    return used;
  }

  function getUsedDishIdsFromPreviousWeeks(currentWeekStart, weeksBack){
    const used = new Set();
    for (let i = 1; i <= weeksBack; i++){
      const prevWeekStart = addDays(currentWeekStart, -7 * i);
      const prevIso = toISO(prevWeekStart);
      const prevUsed = getUsedDishIdsForWeek(prevIso);
      prevUsed.forEach(id => used.add(id));
    }
    return used;
  }

  function smartPickDishForMeal(dayObj, meal, usedDayIds, usedWeekIds, usedHistoryIds, emptySlotsBeforePick){
    const avoid = new Set([...usedDayIds, ...usedWeekIds, ...usedHistoryIds]);
    const bounds = getBounds();
    const tar = state.targets || {};
    const enforceCal = (Number(tar.cal)||0) > 0;
    const enforceCarb = (Number(tar.carbs)||0) > 0;
    const needMeetMinAtEnd = (emptySlotsBeforePick === 1);

    function okProjected(proj){
      if (enforceCal && proj.cal > bounds.calMax + 1e-9) return false;
      if (enforceCarb && proj.carbs > bounds.carbMax + 1e-9) return false;

      if (needMeetMinAtEnd){
        if (enforceCal && proj.cal < bounds.calMin - 1e-9) return false;
        if (enforceCarb && proj.carbs < bounds.carbMin - 1e-9) return false;
      }
      return true;
    }

    const poolAll = dishesForMeal(meal);
    const pool = [];
    for (const d of poolAll){
      if (avoid.has(d.id)) continue;
      const proj = dayTotalsIfAddDish(dayObj, d);
      if (!okProjected(proj)) continue;
      pool.push(d);
    }

    if (!pool.length) return null;

    if (!hasTargets()){
      return pool[Math.floor(Math.random()*pool.length)].id;
    }

    let best=null, bestScore=Infinity;
    for (const d of pool){
      const proj = dayTotalsIfAddDish(dayObj, d);
      const s = scoreAgainstTargets(proj);
      if (s < bestScore){ bestScore=s; best=d; }
    }
    return best?.id ?? null;
  }

  // ---------- Day menu actions ----------
  function isDayLocked(plan, day){ return !!plan[day]._locked; }

  function clearDay(plan, day){
    if (isDayLocked(plan, day)) return toast(`${day} is locked`, "warn");
    if (!confirm(`Clear all meals for ${day}?`)) return;
    const wasLocked = !!plan[day]._locked;
    plan[day] = emptyDay();
    plan[day]._locked = wasLocked;
    saveState();
    renderWeek();
  }

  function fillDayEmptySmart(plan, day){
    if (isDayLocked(plan, day)) return toast(`${day} is locked`, "warn");
    if (!state.dishes.length) return toast("Add dishes first", "warn");

    const usedHistory = STRICT_NO_REPEATS ? getUsedDishIdsFromPreviousWeeks(weekStart, NO_REPEAT_WEEKS_BACK) : new Set();
    const usedWeek = new Set();
    for (const d of DAYS){
      const obj = plan[d];
      for (const m of MEALS){
        const id = obj[m]?.dishId;
        if (id) usedWeek.add(id);
      }
    }

    const dayObj = plan[day];
    const usedDay = new Set();
    for (const meal of MEALS){
      const id = dayObj[meal]?.dishId;
      if (id) usedDay.add(id);
    }

    let placed = 0;
    let failed = 0;

    for (const meal of MEALS){
      if (dayObj[meal]?.dishId) continue;

      const emptiesBefore = remainingEmptySlots(dayObj);
      const pick = STRICT_NO_REPEATS
        ? smartPickDishForMeal(dayObj, meal, usedDay, usedWeek, usedHistory, emptiesBefore)
        : smartPickDishForMeal(dayObj, meal, usedDay, new Set(), new Set(), emptiesBefore);

      if (!pick) { failed++; continue; }

      dayObj[meal] = { dishId: pick, servings: 1 };
      usedDay.add(pick);
      usedWeek.add(pick);
      placed++;
    }

    saveState();
    renderWeek();

    if (failed > 0){
      toast(`Filled ${placed} slot(s). ${failed} left empty (no eligible dishes for category/tolerance).`, "warn");
    } else {
      toast(`Filled empty meals for ${day}`);
    }
  }

  // ---------- Week actions ----------
  function fillWeekOnlyEmptySmart(){
    const plan = ensureWeekPlan();
    if (!state.dishes.length) return toast("Add dishes first", "warn");

    const usedHistory = STRICT_NO_REPEATS ? getUsedDishIdsFromPreviousWeeks(weekStart, NO_REPEAT_WEEKS_BACK) : new Set();

    const usedWeek = new Set();
    for (const day of DAYS){
      const dayObj = plan[day];
      for (const meal of MEALS){
        const id = dayObj[meal]?.dishId;
        if (id) usedWeek.add(id);
      }
    }

    let placed = 0;
    let failed = 0;

    for (const day of DAYS){
      if (isDayLocked(plan, day)) continue;

      const dayObj = plan[day];
      const usedDay = new Set();
      for (const meal of MEALS){
        const id = dayObj[meal]?.dishId;
        if (id) usedDay.add(id);
      }

      for (const meal of MEALS){
        if (dayObj[meal]?.dishId) continue;

        const emptiesBefore = remainingEmptySlots(dayObj);
        const pick = STRICT_NO_REPEATS
          ? smartPickDishForMeal(dayObj, meal, usedDay, usedWeek, usedHistory, emptiesBefore)
          : smartPickDishForMeal(dayObj, meal, usedDay, new Set(), new Set(), emptiesBefore);

        if (!pick) { failed++; continue; }

        dayObj[meal] = { dishId: pick, servings: 1 };
        usedDay.add(pick);
        usedWeek.add(pick);
        placed++;
      }
    }

    saveState();
    renderWeek();

    if (failed > 0) {
      toast(`Filled ${placed} slot(s). ${failed} left empty (no eligible dishes for category/tolerance).`, "warn");
    } else {
      toast("Filled empty meals (strict)");
    }
  }

  function shuffleWeek(){
    const plan = ensureWeekPlan();
    if (!state.dishes.length) return toast("Add dishes first", "warn");
    if (!confirm("Shuffle week? This overwrites all unlocked days.")) return;

    const usedHistory = STRICT_NO_REPEATS ? getUsedDishIdsFromPreviousWeeks(weekStart, NO_REPEAT_WEEKS_BACK) : new Set();
    const usedWeek = new Set();

    for (const day of DAYS){
      const dayObj = plan[day];
      if (isDayLocked(plan, day)) {
        for (const meal of MEALS){
          const id = dayObj[meal]?.dishId;
          if (id) usedWeek.add(id);
        }
      }
    }

    let placed = 0;
    let failed = 0;

    for (const day of DAYS){
      if (isDayLocked(plan, day)) continue;

      plan[day].Breakfast = emptyMeal();
      plan[day].Lunch = emptyMeal();
      plan[day].Dinner = emptyMeal();

      const usedDay = new Set();

      for (const meal of MEALS){
        const emptiesBefore = remainingEmptySlots(plan[day]);
        const pick = STRICT_NO_REPEATS
          ? smartPickDishForMeal(plan[day], meal, usedDay, usedWeek, usedHistory, emptiesBefore)
          : smartPickDishForMeal(plan[day], meal, usedDay, new Set(), new Set(), emptiesBefore);

        if (!pick) { failed++; continue; }
        plan[day][meal] = { dishId: pick, servings: 1 };
        usedDay.add(pick);
        usedWeek.add(pick);
        placed++;
      }
    }

    saveState();
    renderWeek();

    if (failed > 0) {
      toast(`Shuffled. Set ${placed} slot(s). ${failed} left empty (no eligible dishes for category/tolerance).`, "warn");
    } else {
      toast("Shuffled week (strict)");
    }
  }

  function copyPlan(){
    const plan = ensureWeekPlan();
    const tar = state.targets || { cal:0, protein:0, carbs:0, fat:0 };
    const header =
      `Meal plan ‚Äî ${fmtRange(weekStart)}\n` +
      `Targets: ${tar.cal||0} kcal, ${tar.protein||0}g P, ${tar.carbs||0}g C, ${tar.fat||0}g F\n\n`;

    const text = header + DAYS.map((day, idx) => {
      const dateObj = addDays(weekStart, idx);
      const dayObj = plan[day];
      const tot = dayTotals(dayObj);
      const mealLines = MEALS.map(meal => {
        const e = dayObj[meal];
        const d = e?.dishId ? getDish(e.dishId) : null;
        const name = d ? d.name : "(empty)";
        const loc = d ? dishLocation(d) : "";
        const locText = loc ? ` ‚Äî ${loc}` : "";
        return `  - ${meal}: ${name}${locText}`;
      }).join("\n");
      const lockText = dayObj._locked ? " (LOCKED)" : "";
      return `${day}${lockText} (${formatDate(dateObj)}) ‚Äî Total: ${Math.round(tot.cal)} kcal, ${Math.round(tot.protein)}P ${Math.round(tot.carbs)}C ${Math.round(tot.fat)}F\n${mealLines}`;
    }).join("\n\n");

    navigator.clipboard?.writeText(text).then(()=>toast("Copied")).catch(()=>toast("Couldn't copy", "warn"));
  }

  function exportWeekCSV(){
    const plan = ensureWeekPlan();
    const rows = [["day","date","locked","meal","dish","recipe_book","page","ingredients","calories","protein_g","carbs_g","fat_g"]];
    DAYS.forEach((day, idx) => {
      const dateObj = addDays(weekStart, idx);
      const dateStr = formatDate(dateObj);

      MEALS.forEach(meal => {
        const e = plan[day][meal];
        const d = e?.dishId ? getDish(e.dishId) : null;
        rows.push([
          day, dateStr, plan[day]._locked ? "1" : "0", meal,
          d ? d.name : "",
          d ? (d.book || "") : "",
          d ? (d.page != null ? d.page : "") : "",
          d ? (Array.isArray(d.ingredients) ? d.ingredients.join("|") : "") : "",
          d ? Math.round(+d.cal||0) : 0,
          d ? Math.round(+d.protein||0) : 0,
          d ? Math.round(+d.carbs||0) : 0,
          d ? Math.round(+d.fat||0) : 0
        ]);
      });
      const tot = dayTotals(plan[day]);
      rows.push([day, dateStr, plan[day]._locked ? "1" : "0", "TOTAL", "", "", "", "", Math.round(tot.cal), Math.round(tot.protein), Math.round(tot.carbs), Math.round(tot.fat)]);
    });

    const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type:"text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `meal-plan-${toISO(weekStart)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ---------- NEW: Export PDF (print A4) ----------
  function exportWeekPDF(){
    const plan = ensureWeekPlan();
    const tar = state.targets || { cal:0, protein:0, carbs:0, fat:0 };
    const tol = getTol();
    const range = fmtRange(weekStart);

    const safe = (s) => String(s ?? "").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    const locationName = (state.weather?.locationName || "").trim();
    const showWx = !!state.weather?.enabled;

    const daysHTML = DAYS.map((day, idx) => {
      const dateObj = addDays(weekStart, idx);
      const dayObj = plan[day];
      const tot = dayTotals(dayObj);

      const w = getWeatherForDate(dateObj);
      const wxText = (showWx && w)
        ? `${weatherEmoji(w.code)} ${Math.round(w.tmax)}¬∞/${Math.round(w.tmin)}¬∞C`
        : "";

      const mealRows = MEALS.map(meal => {
        const e = dayObj[meal];
        const d = e?.dishId ? getDish(e.dishId) : null;
        const name = d ? d.name : "";
        const loc = d ? dishLocation(d) : "";
        const kcal = d ? (Number(d.cal)||0) : 0;
        const p = d ? (Number(d.protein)||0) : 0;
        const c = d ? (Number(d.carbs)||0) : 0;
        const f = d ? (Number(d.fat)||0) : 0;

        return `
          <tr>
            <td class="colMeal">${safe(meal)}</td>
            <td class="colDish">
              <div class="dishName">${safe(name || "‚Äî")}</div>
              ${loc ? `<div class="dishLoc">${safe(loc)}</div>` : ``}
            </td>
            <td class="colNums">${Math.round(kcal)}</td>
            <td class="colNums">${Math.round(p)}</td>
            <td class="colNums">${Math.round(c)}</td>
            <td class="colNums">${Math.round(f)}</td>
          </tr>
        `;
      }).join("");

      return `
        <section class="dayBlock">
          <div class="dayHeader">
            <div>
              <div class="dayTitle">${safe(day)} <span class="date">${safe(formatDate(dateObj))}</span></div>
              ${wxText ? `<div class="wx">${safe(wxText)}${locationName ? ` ‚Ä¢ ${safe(locationName)}` : ""}</div>` : ``}
            </div>
            <div class="totals">
              <div><span class="lbl">Total:</span> <b>${Math.round(tot.cal)}</b> kcal</div>
              <div class="sub">${Math.round(tot.protein)}P ‚Ä¢ ${Math.round(tot.carbs)}C ‚Ä¢ ${Math.round(tot.fat)}F</div>
            </div>
          </div>

          <table class="mealTable">
            <thead>
              <tr>
                <th class="colMeal">Meal</th>
                <th>Dish</th>
                <th class="colNums">kcal</th>
                <th class="colNums">P</th>
                <th class="colNums">C</th>
                <th class="colNums">F</th>
              </tr>
            </thead>
            <tbody>
              ${mealRows}
            </tbody>
          </table>
        </section>
      `;
    }).join("");

    const html = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Meal Plan ‚Äî ${safe(range)}</title>
  <style>
    @page { size: A4; margin: 12mm; }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: #111827;
      margin: 0;
    }
    .pageHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      padding-bottom:10px;
      border-bottom: 2px solid #e5e7eb;
      margin-bottom: 12px;
    }
    .title{
      font-size: 18px;
      font-weight: 900;
      margin:0;
    }
    .range{
      margin-top:4px;
      color:#374151;
      font-size: 12px;
    }
    .meta{
      text-align:right;
      font-size: 12px;
      color:#374151;
      line-height:1.35;
      white-space:nowrap;
    }
    .pillRow{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:flex-end;
    }
    .pill{
      border:1px solid #e5e7eb;
      border-radius:999px;
      padding:3px 8px;
      font-size:11px;
      color:#374151;
      background:#f9fafb;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .dayBlock{
      border:1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px;
      page-break-inside: avoid;
    }
    .dayHeader{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      margin-bottom:8px;
    }
    .dayTitle{
      font-weight:900;
      font-size:14px;
    }
    .date{
      font-weight:600;
      color:#6b7280;
      margin-left:8px;
      font-size:12px;
    }
    .wx{
      margin-top:2px;
      font-size:11px;
      color:#6b7280;
    }
    .totals{
      text-align:right;
      font-size:12px;
    }
    .totals .lbl{ color:#6b7280; font-weight:600; }
    .totals .sub{ color:#6b7280; font-size:11px; margin-top:2px; }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td{
      border-top: 1px solid #e5e7eb;
      padding: 6px 6px;
      vertical-align: top;
    }
    thead th{
      border-top:none;
      text-align:left;
      color:#374151;
      font-size:11px;
      letter-spacing:.02em;
      text-transform: uppercase;
    }
    .colMeal{ width: 20%; color:#374151; font-weight:700; }
    .colNums{ width: 8%; text-align:right; white-space:nowrap; }
    .dishName{ font-weight:800; }
    .dishLoc{ font-style:italic; color:#6b7280; font-size:11px; margin-top:2px; }

    .footer{
      margin-top: 10px;
      font-size: 10px;
      color:#6b7280;
      display:flex;
      justify-content:space-between;
      gap:12px;
      border-top:1px solid #e5e7eb;
      padding-top:8px;
    }

    /* Print niceties */
    @media print{
      a { color: inherit; text-decoration: none; }
    }
  </style>
</head>
<body>
  <div class="pageHeader">
    <div>
      <div class="title">Meal Plan</div>
      <div class="range">${safe(range)}</div>
    </div>
    <div class="meta">
      <div><b>Targets</b>: ${Math.round(tar.cal||0)} kcal ‚Ä¢ ${Math.round(tar.protein||0)}P ‚Ä¢ ${Math.round(tar.carbs||0)}C ‚Ä¢ ${Math.round(tar.fat||0)}F</div>
      <div>Tolerance (kcal): -${tol.calUnderPct}% / +${tol.calOverPct}%</div>
      <div>Tolerance (carbs): -${tol.carbsUnderPct}% / +${tol.carbsOverPct}%</div>
      <div class="pillRow">
        <span class="pill">Breakfast ‚Ä¢ Lunch ‚Ä¢ Dinner</span>
        <span class="pill">Print A4</span>
      </div>
    </div>
  </div>

  <div class="grid">
    ${daysHTML}
  </div>

  <div class="footer">
    <div>Generated: ${safe(new Date().toLocaleString())}</div>
    <div>Tip: In print dialog choose ‚ÄúSave as PDF‚Äù.</div>
  </div>

  <script>
    window.onload = () => {
      // Give layout a tick, then open print dialog
      setTimeout(() => window.print(), 200);
    };
  </script>
</body>
</html>`;

    const w = window.open("", "_blank");
    if (!w) {
      toast("Popup blocked ‚Äî allow popups for this site.", "warn");
      return;
    }
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  // ---------- Ingredients toggle helpers ----------
  function setIngPanelOpen(panelEl, open){
    if (!panelEl) return;
    if (open){
      panelEl.classList.add("open");
      panelEl.style.maxHeight = panelEl.scrollHeight + "px";
    } else {
      panelEl.style.maxHeight = panelEl.scrollHeight + "px";
      requestAnimationFrame(() => {
        panelEl.classList.remove("open");
        panelEl.style.maxHeight = "0px";
      });
    }
  }

  // ---------- Render ----------
  function renderTargetsUI(){
    const tar = state.targets || {};
    const tol = getTol();
    tCal.value = tar.cal ?? "";
    tProtein.value = tar.protein ?? "";
    tCarbs.value = tar.carbs ?? "";
    tFat.value = tar.fat ?? "";
    tolCalUnder.value = tol.calUnderPct;
    tolCalOver.value = tol.calOverPct;
    tolCarbUnder.value = tol.carbsUnderPct;
    tolCarbOver.value = tol.carbsOverPct;
  }

  function renderWeek(){
    const plan = ensureWeekPlan();
    elWeek.innerHTML = "";

    DAYS.forEach((day, idx) => {
      const dateObj = addDays(weekStart, idx);
      const dayObj = plan[day];
      const tot = dayTotals(dayObj);

      const w = getWeatherForDate(dateObj);
      const weatherHTML = (state.weather.enabled && w)
        ? `
          <span class="weatherPill" title="Weather forecast">
            <span class="weatherIcon">${weatherEmoji(w.code)}</span>
            <span class="weatherTemp">${Math.round(w.tmax)}¬∞ / ${Math.round(w.tmin)}¬∞C</span>
          </span>
        `
        : "";

      const locked = !!dayObj._locked;

      const wrap = document.createElement("div");
      wrap.className = "dayCard" + (locked ? " locked" : "");
      wrap.innerHTML = `
        <div class="dayHeader">
          <div class="dayTopRow">
            <div class="dayLeft">
              <strong>${day}${locked ? " üîí" : ""}</strong>
              <div class="micro">
                <span>${formatDate(dateObj)}</span>
                ${weatherHTML}
              </div>
            </div>

            <div class="dayRight">
              <div class="dayTotalsInline" title="Day totals">
                <div class="kcal">${Math.round(tot.cal)} kcal</div>
                <div class="micro">${Math.round(tot.protein)}P ‚Ä¢ ${Math.round(tot.carbs)}C ‚Ä¢ ${Math.round(tot.fat)}F</div>
              </div>

              <div class="dayMenu">
                <button class="kebabBtn" type="button" data-kebab="1" aria-label="Day menu" title="Day menu">
                  <span class="kebabDots">‚ãØ</span>
                </button>

                <div class="menuPanel" data-menu="1" role="menu" aria-label="Day actions">
                  <button class="menuItem ${locked ? "disabled" : ""}" type="button" data-action="fill" role="menuitem" ${locked ? "aria-disabled='true'" : ""}>
                    <span class="menuIcon">‚ú®</span><span>Fill empty meals</span>
                  </button>

                  <div class="menuDivider"></div>

                  <button class="menuItem danger ${locked ? "disabled" : ""}" type="button" data-action="clear" role="menuitem" ${locked ? "aria-disabled='true'" : ""}>
                    <span class="menuIcon">üßπ</span><span>Clear this day</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          ${macroProgressHTML(tot)}
        </div>

        <div class="meals">
          ${MEALS.map(meal => {
            const e = dayObj[meal];
            const d = e?.dishId ? getDish(e.dishId) : null;
            const loc = d ? dishLocation(d) : "";

            const mealCal = d ? (Number(d.cal)||0) : 0;
            const mealP = d ? (Number(d.protein)||0) : 0;
            const mealC = d ? (Number(d.carbs)||0) : 0;
            const mealF = d ? (Number(d.fat)||0) : 0;

            return `
              <div class="mealRow" draggable="true" data-day="${day}" data-meal="${meal}">
                <div class="muted"><strong>${meal}</strong></div>

                <div class="dishBlock">
                  ${d
                    ? `<div class="dishName">${d.name}</div>${loc ? `<div class="dishLoc">${loc}</div>` : ``}`
                    : `<div class="dishName dishEmpty">Tap to assign or drop a dish</div>`
                  }
                </div>

                <div class="micro mealMacros">
                  ${Math.round(mealCal)} kcal ‚Ä¢ ${Math.round(mealP)}P ${Math.round(mealC)}C ${Math.round(mealF)}F
                </div>

                <div class="mealBtn">
                  <button class="miniIcon" type="button" title="Edit" aria-label="Edit" disabled style="opacity:.55;cursor:not-allowed;">‚úèÔ∏è</button>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;

      const kebabBtn = wrap.querySelector('[data-kebab="1"]');
      const menu = wrap.querySelector('[data-menu="1"]');
      kebabBtn.addEventListener("click", (ev) => {
        ev.stopPropagation();
        document.querySelectorAll(".menuPanel.open").forEach(m => { if (m !== menu) m.classList.remove("open"); });
        menu.classList.toggle("open");
      });
      menu.addEventListener("click", (ev) => ev.stopPropagation());

      menu.querySelectorAll("[data-action]").forEach(btn => {
        btn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          if (btn.classList.contains("disabled")) return;

          menu.classList.remove("open");
          const action = btn.dataset.action;

          const plan = ensureWeekPlan();
          if (action === "fill") return fillDayEmptySmart(plan, day);
          if (action === "clear") return clearDay(plan, day);
        });
      });

      wrap.querySelectorAll(".mealRow").forEach(row => {
        const dayName = row.dataset.day;
        const mealName = row.dataset.meal;

        row.addEventListener("click", (ev) => {
          const tag = (ev.target && ev.target.tagName) ? ev.target.tagName.toLowerCase() : "";
          if (tag === "button") return;
          if (!state.ui.selectedDishId) return;
          assignSelectedDishToSlot(dayName, mealName);
        });

        row.addEventListener("dragstart", (ev) => {
          const payload = { type:"mealSlot", day: dayName, meal: mealName };
          ev.dataTransfer.setData("text/plain", JSON.stringify(payload));
          ev.dataTransfer.effectAllowed = "copyMove";
        });

        row.addEventListener("dragover", (ev) => {
          ev.preventDefault();
          row.classList.add("dragOver");
          ev.dataTransfer.dropEffect = "move";
        });
        row.addEventListener("dragleave", () => row.classList.remove("dragOver"));

        row.addEventListener("drop", (ev) => {
          ev.preventDefault();
          row.classList.remove("dragOver");

          const json = ev.dataTransfer.getData("text/plain");
          if (!json) return;

          let payload;
          try { payload = JSON.parse(json); } catch { return; }

          const plan = ensureWeekPlan();
          if (plan[dayName]._locked) return toast(`${dayName} is locked`, "warn");

          if (payload.type === "dish") {
            const dish = getDish(payload.dishId);
            if (!dish) return;

            if (!confirmCategoryMismatchIfNeeded(dish, mealName)) {
              toast("Drop cancelled");
              return;
            }

            plan[dayName][mealName] = { dishId: payload.dishId, servings: 1 };
            saveState();
            renderWeek();
            return;
          }

          if (payload.type === "mealSlot") {
            if (plan[payload.day]._locked) return toast(`${payload.day} is locked`, "warn");
            const a = plan[payload.day][payload.meal];
            const b = plan[dayName][mealName];
            plan[payload.day][payload.meal] = b;
            plan[dayName][mealName] = a;
            saveState();
            renderWeek();
          }
        });
      });

      elWeek.appendChild(wrap);
    });
  }

  // ---------- Kitchen list render ----------
  function renderDishList(){
    const list = filteredDishes(elSearch.value);
    elDishList.innerHTML = "";

    state.ui.expandedIngredients = state.ui.expandedIngredients && typeof state.ui.expandedIngredients === "object"
      ? state.ui.expandedIngredients : {};

    list.forEach(d => {
      const el = document.createElement("div");
      el.className = "dish";
      el.setAttribute("draggable","true");
      el.dataset.dishId = d.id;

      if (state.ui.selectedDishId === d.id) el.classList.add("selected");

      const loc = dishLocation(d);
      const cats = d.categories || {};
      const catText = ["Breakfast","Lunch","Dinner"].filter(m => cats[m]).join(", ") || "‚Äî";
      const ingText = ingredientsToText(d.ingredients);
      const hasIngredients = !!ingText;
      const expanded = hasIngredients ? !!state.ui.expandedIngredients[d.id] : false;

      if (!hasIngredients && state.ui.expandedIngredients[d.id]) {
        delete state.ui.expandedIngredients[d.id];
        saveState();
      }

      el.innerHTML = `
        <div>
          <div>
            <strong>${d.name}</strong>
            <small class="micro">(${d.cal} kcal, ${d.protein}P, ${d.carbs}C, ${d.fat}F)</small>
          </div>

          ${loc ? `<div class="micro"><i>${loc}</i></div>` : ""}

          ${
            hasIngredients
              ? `<div class="ingPanel ${expanded ? "open" : ""}" data-ings-panel="${d.id}">
                   <em>${ingText}</em>
                 </div>`
              : ``
          }

          <div class="micro" style="margin-top:6px;">Categories: ${catText}</div>
        </div>

        <div class="dishActions">
          ${
            hasIngredients
              ? `<button class="miniIcon" data-toggle-ings="${d.id}"
                   title="${expanded ? "Hide ingredients" : "Show ingredients"}"
                   aria-label="${expanded ? "Hide ingredients" : "Show ingredients"}"
                   aria-pressed="${expanded}">
                   ${expanded ? ICON_CLOSE : ICON_LIST}
                 </button>`
              : ``
          }
          <button class="miniIcon" data-edit="${d.id}" title="Edit dish" aria-label="Edit">‚úèÔ∏è</button>
          <button class="miniIcon danger" data-delete="${d.id}" title="Delete dish" aria-label="Delete">üóëÔ∏è</button>
        </div>
      `;

      const panel = hasIngredients ? el.querySelector(`[data-ings-panel="${d.id}"]`) : null;
      if (hasIngredients) panel.style.maxHeight = expanded ? (panel.scrollHeight + "px") : "0px";

      el.addEventListener("click", (ev) => {
        const t = ev.target;
        if (t && t.closest && t.closest(".dishActions")) return;
        if (state.ui.selectedDishId === d.id) clearSelectedDish();
        else setSelectedDish(d.id);
      });

      el.addEventListener("dragstart", (ev) => {
        const payload = { type:"dish", dishId: d.id };
        ev.dataTransfer.setData("text/plain", JSON.stringify(payload));
        ev.dataTransfer.effectAllowed = "copyMove";
      });

      if (hasIngredients) {
        el.querySelector(`[data-toggle-ings="${d.id}"]`).addEventListener("click", (ev) => {
          ev.stopPropagation();

          const nowOpen = !state.ui.expandedIngredients[d.id];
          state.ui.expandedIngredients[d.id] = nowOpen;

          const btn = ev.currentTarget;
          btn.innerHTML = nowOpen ? ICON_CLOSE : ICON_LIST;
          btn.title = nowOpen ? "Hide ingredients" : "Show ingredients";
          btn.setAttribute("aria-label", btn.title);
          btn.setAttribute("aria-pressed", String(nowOpen));

          setIngPanelOpen(panel, nowOpen);
          saveState();
        });
      }

      el.querySelector("[data-edit]").addEventListener("click", (ev) => { ev.stopPropagation(); editDish(d.id); });
      el.querySelector("[data-delete]").addEventListener("click", (ev) => { ev.stopPropagation(); deleteDish(d.id); });

      elDishList.appendChild(el);
    });

    elCount.textContent = `${state.dishes.length} dish${state.dishes.length===1? "" : "es"}`;
  }

  // ---------- Weather dialog UI ----------
  function syncWeatherDialogUI(){
    showWeather.checked = !!state.weather.enabled;
    locationQuery.value = "";
    setLocationStatus();
  }
  weatherBtn.addEventListener("click", () => {
    syncWeatherDialogUI();
    weatherDialog.showModal();
  });
  closeWeather.addEventListener("click", () => weatherDialog.close());
  useMyLocation.addEventListener("click", async () => {
    showWeather.checked = true;
    state.weather.enabled = true;
    saveState();
    await setLocationByGeolocation();
  });
  findLocation.addEventListener("click", async () => {
    showWeather.checked = true;
    state.weather.enabled = true;
    saveState();
    await setLocationBySearch(locationQuery.value);
  });
  locationQuery.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); findLocation.click(); }
  });
  clearLocationBtn.addEventListener("click", () => {
    clearWeatherLocation();
    syncWeatherDialogUI();
    toast("Location cleared");
  });
  saveWeatherBtn.addEventListener("click", async () => {
    state.weather.enabled = !!showWeather.checked;
    if (!state.weather.enabled) state.weather.cacheByWeek = {};
    saveState();
    if (state.weather.enabled) await fetchWeatherForWeek();
    renderWeek();
    weatherDialog.close();
  });

  // Mobile kitchen collapse
  function applyPantryCollapsed(){
    const collapsed = !!state.uiPrefs.pantryCollapsedMobile;
    const lower = KITCHEN_LABEL.toLowerCase();

    if (collapsed) {
      mainRoot.classList.add("pantryCollapsed");
      mobilePantryStatus.textContent = `${KITCHEN_LABEL} hidden`;
      togglePantryBtn.textContent = `Show ${lower}`;
    } else {
      mainRoot.classList.remove("pantryCollapsed");
      mobilePantryStatus.textContent = `${KITCHEN_LABEL} shown`;
      togglePantryBtn.textContent = `Hide ${lower}`;
    }
  }
  togglePantryBtn.addEventListener("click", () => {
    state.uiPrefs.pantryCollapsedMobile = !state.uiPrefs.pantryCollapsedMobile;
    saveState();
    applyPantryCollapsed();
  });

  // ---------- Wire up controls ----------
  document.getElementById("saveTargets").addEventListener("click", saveTargets);
  document.getElementById("fillEmpty").addEventListener("click", fillWeekOnlyEmptySmart);
  document.getElementById("shuffleWeek").addEventListener("click", shuffleWeek);
  document.getElementById("copyPlan").addEventListener("click", copyPlan);
  document.getElementById("exportCSV").addEventListener("click", exportWeekCSV);
  document.getElementById("exportPDF").addEventListener("click", exportWeekPDF);

  document.getElementById("prevWeek").addEventListener("click", async ()=>{ weekStart = addDays(weekStart,-7); await fetchWeatherForWeek(); renderAll(); });
  document.getElementById("nextWeek").addEventListener("click", async ()=>{ weekStart = addDays(weekStart, 7); await fetchWeatherForWeek(); renderAll(); });

  document.getElementById("clearWeek").addEventListener("click", () => {
    const label = fmtRange(weekStart);
    if (!confirm(`Clear ALL days for this week (${label})? This cannot be undone.`)) return;
    const plan = ensureWeekPlan();
    DAYS.forEach(d => {
      if (!plan[d]._locked) plan[d] = emptyDay();
      else { const wasLocked = true; plan[d] = emptyDay(); plan[d]._locked = wasLocked; }
    });
    saveState();
    renderWeek();
  });

  document.getElementById("reset").addEventListener("click", ()=>{
    if (!confirm("Reset dishes, targets, tolerances, and all saved plans on this device?")) return;
    localStorage.removeItem(KEY);
    state = defaultState();
    weekStart = startOfWeek(new Date());
    saveState();
    renderAll();
    toast("Reset");
  });

  clearSelected.addEventListener("click", clearSelectedDish);

  elSearch.addEventListener("input", renderDishList);
  document.getElementById("clearSearch").addEventListener("click", ()=>{ elSearch.value=""; renderDishList(); elSearch.focus(); });
  [filterBreakfast, filterLunch, filterDinner].forEach(cb => cb.addEventListener("change", renderDishList));

  document.getElementById("saveDish").addEventListener("click", saveDishFromForm);
  document.getElementById("importBulk").addEventListener("click", importBulkCSV);
  elDishName.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); saveDishFromForm(); } });

  importCsvFileBtn.addEventListener("click", async () => { await importCsvFromFile(csvFile.files?.[0]); });
  exportJsonBtn.addEventListener("click", exportJSON);
  importJsonFileBtn.addEventListener("click", async () => { await importJSONFromFile(jsonFile.files?.[0]); });

  catBreakfast.checked = true;
  catLunch.checked = true;
  catDinner.checked = true;

  if (window.matchMedia("(min-width: 921px)").matches) {
    dishAdminDetails.open = false;
  }

  function renderAll(){
    elWeekRange.textContent = fmtRange(weekStart);
    renderTargetsUI();
    updateSelectedDishUI();
    renderDishList();
    renderWeek();
    syncWeatherDialogUI();
    applyPantryCollapsed();
  }

  (async () => {
    applyPantryCollapsed();
    elWeekRange.textContent = fmtRange(weekStart);
    renderTargetsUI();
    updateSelectedDishUI();
    renderDishList();
    syncWeatherDialogUI();
    if (state.weather.enabled) await fetchWeatherForWeek();
    renderWeek();
    setLocationStatus();
  })();
})();
</script>
</body>
</html>
